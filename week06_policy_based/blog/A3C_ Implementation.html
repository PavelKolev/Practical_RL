<!DOCTYPE html>
<!-- saved from url=(0064)https://jaromiru.com/2017/03/26/lets-make-an-a3c-implementation/ -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Let’s make an A3C: Implementation – ヤロミル</title>
    <link rel="dns-prefetch" href="https://maxcdn.bootstrapcdn.com/">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="MACHINE LEARNING &amp; AI">
    <meta name="robots" content="all">
    <meta name="author" content="Jaromír Janisch">
    
    <meta name="keywords" content="">
    <link rel="canonical" href="https://jaromiru.com/2017/03/26/lets-make-an-a3c-implementation/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for ヤロミル" href="https://jaromiru.com/feed.xml">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="./A3C_ Implementation_files/pixyll.css" type="text/css">

    <!-- Fonts -->
    <link href="./A3C_ Implementation_files/css" rel="stylesheet" type="text/css">
    <link href="./A3C_ Implementation_files/css(1)" rel="stylesheet" type="text/css">

    

    <!-- MathJax -->
    
    <script type="text/javascript" async="" src="./A3C_ Implementation_files/analytics.js.download"></script><script type="text/javascript" async="" src="./A3C_ Implementation_files/MathJax.js.download">
    </script>
    

    <!-- Verifications -->
    
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Let’s make an A3C: Implementation">
    <meta property="og:description" content="MACHINE LEARNING &amp; AI">
    <meta property="og:url" content="https://jaromiru.com/2017/03/26/lets-make-an-a3c-implementation/">
    <meta property="og:site_name" content="ヤロミル">
    

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="Let’s make an A3C: Implementation">
    <meta name="twitter:description" content="MACHINE LEARNING &amp; AI">
    <meta name="twitter:url" content="https://jaromiru.com/2017/03/26/lets-make-an-a3c-implementation/">
    

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://jaromiru.com/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://jaromiru.com/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://jaromiru.com/favicon-16x16.png">
    <link rel="manifest" href="https://jaromiru.com/site.webmanifest">

    <!-- Google Analytics -->
    <script async="" src="./A3C_ Implementation_files/js"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-133811904-1');
    </script>
<script type="text/javascript" async="" src="./A3C_ Implementation_files/embed.js.download"></script><link rel="prefetch" as="style" href="https://c.disquscdn.com/next/embed/styles/lounge.6525595c7a9874fa10bd041275e40f17.css"><link rel="prefetch" as="script" href="https://c.disquscdn.com/next/embed/common.bundle.f9de3d662c5d03c937747411c45f2ea2.js"><link rel="prefetch" as="script" href="https://c.disquscdn.com/next/embed/lounge.bundle.277f9ff2e410eacf604c2762b3003e57.js"><link rel="prefetch" as="script" href="https://disqus.com/next/config.js"><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 2px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 2px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: 1em}
.MathJax_MenuRadioCheck.RTL {right: 1em; left: auto}
.MathJax_MenuLabel {padding: 2px 2em 4px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #CCCCCC; margin: 4px 1px 0px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: Highlight; color: HighlightText}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><style type="text/css">.MathJax_Display {text-align: center; margin: 1em 0em; position: relative; display: block!important; text-indent: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; width: 100%}
.MathJax .merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MathJax .MJX-monospace {font-family: monospace}
.MathJax .MJX-sans-serif {font-family: sans-serif}
#MathJax_Tooltip {background-color: InfoBackground; color: InfoText; border: 1px solid black; box-shadow: 2px 2px 5px #AAAAAA; -webkit-box-shadow: 2px 2px 5px #AAAAAA; -moz-box-shadow: 2px 2px 5px #AAAAAA; -khtml-box-shadow: 2px 2px 5px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true'); padding: 3px 4px; z-index: 401; position: absolute; left: 0; top: 0; width: auto; height: auto; display: none}
.MathJax {display: inline; font-style: normal; font-weight: normal; line-height: normal; font-size: 100%; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0}
.MathJax:focus, body :focus .MathJax {display: inline-table}
.MathJax.MathJax_FullWidth {text-align: center; display: table-cell!important; width: 10000em!important}
.MathJax img, .MathJax nobr, .MathJax a {border: 0; padding: 0; margin: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; vertical-align: 0; line-height: normal; text-decoration: none}
img.MathJax_strut {border: 0!important; padding: 0!important; margin: 0!important; vertical-align: 0!important}
.MathJax span {display: inline; position: static; border: 0; padding: 0; margin: 0; vertical-align: 0; line-height: normal; text-decoration: none}
.MathJax nobr {white-space: nowrap!important}
.MathJax img {display: inline!important; float: none!important}
.MathJax * {transition: none; -webkit-transition: none; -moz-transition: none; -ms-transition: none; -o-transition: none}
.MathJax_Processing {visibility: hidden; position: fixed; width: 0; height: 0; overflow: hidden}
.MathJax_Processed {display: none!important}
.MathJax_ExBox {display: block!important; overflow: hidden; width: 1px; height: 60ex; min-height: 0; max-height: none}
.MathJax .MathJax_EmBox {display: block!important; overflow: hidden; width: 1px; height: 60em; min-height: 0; max-height: none}
.MathJax_LineBox {display: table!important}
.MathJax_LineBox span {display: table-cell!important; width: 10000em!important; min-width: 0; max-width: none; padding: 0; border: 0; margin: 0}
.MathJax .MathJax_HitBox {cursor: text; background: white; opacity: 0; filter: alpha(opacity=0)}
.MathJax .MathJax_HitBox * {filter: none; opacity: 1; background: transparent}
#MathJax_Tooltip * {filter: none; opacity: 1; background: transparent}
@font-face {font-family: MathJax_Main; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Main-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Main-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Main-bold; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Main-Bold.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Main-Bold.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Main-italic; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Main-Italic.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Main-Italic.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Math-italic; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Math-Italic.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Math-Italic.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Caligraphic; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Caligraphic-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Caligraphic-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size1; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size1-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size1-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size2; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size2-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size2-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size3; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size3-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size3-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size4; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size4-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size4-Regular.otf?V=2.7.1') format('opentype')}
.MathJax .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><script src="./A3C_ Implementation_files/alfie.f51946af45e0b561c60f768335c9eb79.js.download" async="" charset="UTF-8"></script></head>

<body class="site"><div style="visibility: hidden; overflow: hidden; position: absolute; top: 0px; height: 1px; width: auto; padding: 0px; border: 0px; margin: 0px; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal;"><div id="MathJax_Hidden"></div></div><div id="MathJax_Message" style="display: none;"></div>
  
	

  <div class="site-wrap">
    <header class="site-header px2 px-responsive" id="header">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="https://jaromiru.com/" class="site-title">ヤロミル</a>
      <nav class="site-nav">
        



    
    
    
    

    

    
    
    
    
        <a class="nav-link" href="https://jaromiru.com/about/">About me</a>
    

    

    
    
    
    

    

    
    
    
    

    

    
    
    
    

    


      </nav>
      <div class="clearfix"></div>
      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>Let’s make an A3C: Implementation</h1>
  <span class="post-meta">26 March, 2017</span><br>
  
<!--   <span class="post-meta small">
  
    17 
  
  </span> -->
</div>

<article class="post-content">
  <div style="border:1px solid #919191;padding:10px;background-color:#fafafa;">
  <p>This article is part of series <i>Let’s make an A3C</i>.</p>

  <ol>
    <li><a href="https://jaromiru.com/2017/02/16/lets-make-an-a3c-theory">Theory</a></li>
    <li><a href="https://jaromiru.com/2017/03/26/lets-make-an-a3c-implementation">Implementation</a></li>
  </ol>
</div>

<h2 id="introduction">Introduction</h2>
<p>In the previous article we built necessary knowledge about Policy Gradient Methods and A3C algorithm. This time we implement a simple agent with our familiar tools - Python, Keras and OpenAI Gym. However, more low level implementation is needed and that’s where TensorFlow comes to play.</p>

<p>The environment is the same as in DQN implementation - <em>CartPole</em>. Final code fits inside 300 lines and is easily converted to any other problem. A3C algorithm is very effective and learning takes only 30 seconds on a regular notebook.</p>

<!--more-->

<p>The code presented here however isn’t the original vanilla A3C algorithm, but it has multiple advances incorporated into it. Notably, it leverages the use of GPU with a custom implementation inspired by recent NVIDIA work<sup id="fnref:2"><a href="https://jaromiru.com/2017/03/26/lets-make-an-a3c-implementation/#fn:2" class="footnote">1</a></sup> and n-step return.</p>

<p>The complete code is available at <a href="https://github.com/jaromiru/AI-blog/blob/master/CartPole-A3C.py">GitHub</a>.</p>

<h2 id="n-step-return">N-step return</h2>
<p>Before we delve into the implementation itself, let’s explain one more concept.</p>

<p>Usually we used something called 1-step return when we computed <em>Q(s, a)</em>, <em>V(s)</em> or <em>A(s, a)</em> functions. That means that we looked only one step ahead. For example, when setting a target of a value function:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-1-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mover&gt;&lt;mo&gt;&amp;#x2192;&lt;/mo&gt;&lt;mpadded width=&quot;+0.611em&quot; lspace=&quot;0.278em&quot; voffset=&quot;.15em&quot; /&gt;&lt;/mover&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-1" style="width: 10.729em; display: inline-block;"><span style="display: inline-block; position: relative; width: 9.147em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.284em, 1009.06em, 2.652em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-2"><span class="mi" id="MathJax-Span-3" style="font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-4" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-5"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-6" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-7" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-8" style="font-family: MathJax_Main;">)</span><span class="munderover" id="MathJax-Span-9" style="padding-left: 0.301em;"><span style="display: inline-block; position: relative; width: 0.985em; height: 0px;"><span style="position: absolute; clip: rect(3.378em, 1000.94em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mo" id="MathJax-Span-10" style=""><span style="font-family: MathJax_Main;">→</span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.72em, 1000.22em, 4.147em, -999.998em); top: -4.741em; left: 0.259em;"><span class="mpadded" id="MathJax-Span-11"><span style="display: inline-block; position: relative; width: 0.515em; height: 0px;"><span style="position: absolute; clip: rect(3.891em, 1000em, 4.147em, -999.998em); top: -4.186em; left: 0.216em;"><span class="mrow" id="MathJax-Span-12"></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-13" style="padding-left: 0.301em;"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-14" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-15" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-16" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="mi" id="MathJax-Span-17" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span class="mi" id="MathJax-Span-18" style="font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-19" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-20"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-21" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-22" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-23" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.353em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>V</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mn>0</mn></msub><mo stretchy="false">)</mo><mover><mo>→</mo><mpadded width="+0.611em" lspace="0.278em" voffset=".15em"></mpadded></mover><msub><mi>r</mi><mn>0</mn></msub><mo>+</mo><mi>γ</mi><mi>V</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mn>1</mn></msub><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-1">V(s_0) \xrightarrow{} r_0 + \gamma V(s_1)</script>

<p>In this case we used an immediate return from <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-2-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-24" style="width: 6.754em; display: inline-block;"><span style="display: inline-block; position: relative; width: 5.771em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1005.69em, 2.652em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-25"><span class="mo" id="MathJax-Span-26" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-27"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-28" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-29" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-30" style="font-family: MathJax_Main;">,</span><span class="msubsup" id="MathJax-Span-31" style="padding-left: 0.173em;"><span style="display: inline-block; position: relative; width: 0.942em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.51em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-32" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.515em;"><span class="mn" id="MathJax-Span-33" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-34" style="font-family: MathJax_Main;">,</span><span class="msubsup" id="MathJax-Span-35" style="padding-left: 0.173em;"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-36" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-37" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-38" style="font-family: MathJax_Main;">,</span><span class="msubsup" id="MathJax-Span-39" style="padding-left: 0.173em;"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-40" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-41" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-42" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.252em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo stretchy="false">(</mo><msub><mi>s</mi><mn>0</mn></msub><mo>,</mo><msub><mi>a</mi><mn>0</mn></msub><mo>,</mo><msub><mi>r</mi><mn>0</mn></msub><mo>,</mo><msub><mi>s</mi><mn>1</mn></msub><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-2">(s_0, a_0, r_0, s_1)</script> sample and an estimated value of the function in the next step to give us an approximation. However, we can use more steps to give us another approximation:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-3-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mover&gt;&lt;mo&gt;&amp;#x2192;&lt;/mo&gt;&lt;mpadded width=&quot;+0.611em&quot; lspace=&quot;0.278em&quot; voffset=&quot;.15em&quot; /&gt;&lt;/mover&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-43" style="width: 14.361em; display: inline-block;"><span style="display: inline-block; position: relative; width: 12.267em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.241em, 1012.18em, 2.652em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-44"><span class="mi" id="MathJax-Span-45" style="font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-46" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-47"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-48" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-49" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-50" style="font-family: MathJax_Main;">)</span><span class="munderover" id="MathJax-Span-51" style="padding-left: 0.301em;"><span style="display: inline-block; position: relative; width: 0.985em; height: 0px;"><span style="position: absolute; clip: rect(3.378em, 1000.94em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mo" id="MathJax-Span-52" style=""><span style="font-family: MathJax_Main;">→</span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.72em, 1000.22em, 4.147em, -999.998em); top: -4.741em; left: 0.259em;"><span class="mpadded" id="MathJax-Span-53"><span style="display: inline-block; position: relative; width: 0.515em; height: 0px;"><span style="position: absolute; clip: rect(3.891em, 1000em, 4.147em, -999.998em); top: -4.186em; left: 0.216em;"><span class="mrow" id="MathJax-Span-54"></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-55" style="padding-left: 0.301em;"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-56" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-57" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-58" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="mi" id="MathJax-Span-59" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span class="msubsup" id="MathJax-Span-60"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-61" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-62" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-63" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="msubsup" id="MathJax-Span-64" style="padding-left: 0.216em;"><span style="display: inline-block; position: relative; width: 1.028em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-65" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="mn" id="MathJax-Span-66" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mi" id="MathJax-Span-67" style="font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-68" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-69"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-70" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-71" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-72" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.453em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>V</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mn>0</mn></msub><mo stretchy="false">)</mo><mover><mo>→</mo><mpadded width="+0.611em" lspace="0.278em" voffset=".15em"></mpadded></mover><msub><mi>r</mi><mn>0</mn></msub><mo>+</mo><mi>γ</mi><msub><mi>r</mi><mn>1</mn></msub><mo>+</mo><msup><mi>γ</mi><mn>2</mn></msup><mi>V</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mn>2</mn></msub><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-3">V(s_0) \xrightarrow{} r_0 + \gamma r_1 + \gamma^2 V(s_2)</script>

<p>or in general a n-step return:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-4-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mover&gt;&lt;mo&gt;&amp;#x2192;&lt;/mo&gt;&lt;mpadded width=&quot;+0.611em&quot; lspace=&quot;0.278em&quot; voffset=&quot;.15em&quot; /&gt;&lt;/mover&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msup&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-73" style="width: 16.498em; display: inline-block;"><span style="display: inline-block; position: relative; width: 14.105em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.284em, 1014.02em, 2.652em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-74"><span class="mi" id="MathJax-Span-75" style="font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-76" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-77"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-78" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-79" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-80" style="font-family: MathJax_Main;">)</span><span class="munderover" id="MathJax-Span-81" style="padding-left: 0.301em;"><span style="display: inline-block; position: relative; width: 0.985em; height: 0px;"><span style="position: absolute; clip: rect(3.378em, 1000.94em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mo" id="MathJax-Span-82" style=""><span style="font-family: MathJax_Main;">→</span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.72em, 1000.22em, 4.147em, -999.998em); top: -4.741em; left: 0.259em;"><span class="mpadded" id="MathJax-Span-83"><span style="display: inline-block; position: relative; width: 0.515em; height: 0px;"><span style="position: absolute; clip: rect(3.891em, 1000em, 4.147em, -999.998em); top: -4.186em; left: 0.216em;"><span class="mrow" id="MathJax-Span-84"></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-85" style="padding-left: 0.301em;"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-86" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-87" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-88" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="mi" id="MathJax-Span-89" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span class="msubsup" id="MathJax-Span-90"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-91" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-92" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-93" style="font-family: MathJax_Main;">+</span><span class="mo" id="MathJax-Span-94" style="font-family: MathJax_Main;">.</span><span class="mo" id="MathJax-Span-95" style="font-family: MathJax_Main; padding-left: 0.173em;">.</span><span class="mo" id="MathJax-Span-96" style="font-family: MathJax_Main; padding-left: 0.173em;">.</span><span class="mo" id="MathJax-Span-97" style="font-family: MathJax_Main; padding-left: 0.173em;">+</span><span class="msubsup" id="MathJax-Span-98"><span style="display: inline-block; position: relative; width: 1.113em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-99" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="mi" id="MathJax-Span-100" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mi" id="MathJax-Span-101" style="font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-102" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-103"><span style="display: inline-block; position: relative; width: 0.985em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-104" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mi" id="MathJax-Span-105" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-106" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.353em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>V</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mn>0</mn></msub><mo stretchy="false">)</mo><mover><mo>→</mo><mpadded width="+0.611em" lspace="0.278em" voffset=".15em"></mpadded></mover><msub><mi>r</mi><mn>0</mn></msub><mo>+</mo><mi>γ</mi><msub><mi>r</mi><mn>1</mn></msub><mo>+</mo><mo>.</mo><mo>.</mo><mo>.</mo><mo>+</mo><msup><mi>γ</mi><mi>n</mi></msup><mi>V</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mi>n</mi></msub><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-4">V(s_0) \xrightarrow{} r_0 + \gamma r_1 + ... + \gamma^n V(s_n)</script>

<p>The n-step return has an advantage that changes in the approximated function get propagated much more quickly. Let’s say that the agent experienced a transition with unexpected reward. In 1-step return scenario, the value function would only change slowly one step backwards with each iteration. In n-step return however, the change is propagated <em>n</em> steps backwards each iteration, thus much quicker.</p>

<p>N-step return has its drawbacks. It’s higher variance because the value depends on a chain of actions which can lead into many different states. This might endanger the convergence.</p>

<p>We can also compute it only when enough samples are available, thus it is delayed. As we know, A3C algorithm needs its samples to be made by current policy and by the time we can compute n-step return the policy might have slightly changed. So this delay introduces some deviation and also threatens the convergence.</p>

<p>We need to keep these properties in mind when introducing n-step return. In practice, however, reasonable values of <em>n</em> help.</p>

<h2 id="implementation">Implementation</h2>
<p>Let’s first see the big picture. The A3C algorithm contains several key concepts that all make it work. Multiple separate environments are run in parallel, each of which contains an agent. The agents however share one neural network. Samples produced by agents are gathered in a queue, from where they are asynchronously used by a separate optimizer thread to improve the policy. The diagram below shows how these components work together:</p>

<p><img class="w70" src="./A3C_ Implementation_files/diagram.png" alt="Component diagram"></p>

<p>We will implement four classes - <code class="language-plaintext highlighter-rouge">Environment</code>, <code class="language-plaintext highlighter-rouge">Agent</code>, <code class="language-plaintext highlighter-rouge">Brain</code> and <code class="language-plaintext highlighter-rouge">Optimizer</code>. Two of these are thread classes - <code class="language-plaintext highlighter-rouge">Environment</code> and <code class="language-plaintext highlighter-rouge">Optimizer</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Environment</span> <span class="p">:</span><span class="n">Thread</span>
    <span class="n">run</span><span class="p">()</span>               <span class="c1"># runs episodes in loop
</span>
<span class="n">Agent</span>
    <span class="n">act</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>              <span class="c1"># decides what action to take in state s
</span>    <span class="n">train</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>       <span class="c1"># processes sample and add it to the train queue
</span>
<span class="n">Brain</span>
    <span class="n">predict</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>          <span class="c1"># outputs pi(s) and V(s)
</span>    <span class="n">train_push</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>  <span class="c1"># adds sample to the training queue
</span>    <span class="n">optimize</span><span class="p">()</span>          <span class="c1"># does the gradient descent step
</span>
<span class="n">Optimizer</span>   <span class="p">:</span><span class="n">Thread</span>
    <span class="n">run</span><span class="p">()</span>               <span class="c1"># calls brain.optimize() in loop
</span></code></pre></div></div>

<h3 id="environment">Environment</h3>
<p>The <code class="language-plaintext highlighter-rouge">Environment</code> class is an instance of OpenAI Gym environment and contains an instance of <code class="language-plaintext highlighter-rouge">Agent</code>. It is also a thread that continuously runs one episode after another.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_signal</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runEpisode</span><span class="p">()</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">runEpisode()</code> method is simple:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">runEpisode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>         
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">THREAD_DELAY</span><span class="p">)</span> <span class="c1"># yield 
</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">s_</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">done</span><span class="p">:</span> <span class="c1"># terminal state
</span>                <span class="n">s_</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s_</span><span class="p">)</span>

            <span class="n">s</span> <span class="o">=</span> <span class="n">s_</span>

            <span class="k">if</span> <span class="n">done</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_signal</span><span class="p">:</span>
                <span class="k">break</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">THREAD_DELAY</code> parameter controls a delay between steps and enables to have more parallel environments than there are CPUs. High number of agents is crucial for convergence of the algorithm as the gradient approximation quality depends on high diversity of samples.</p>

<h3 id="agent">Agent</h3>
<p>In <code class="language-plaintext highlighter-rouge">Agent</code> class, the <code class="language-plaintext highlighter-rouge">act()</code> method returns an action to take. To support exploration, it implements ε-greedy policy with linearly decreasing rate. The action is selected according to the policy distribution returned by the neural network.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NUM_ACTIONS</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">brain</span><span class="o">.</span><span class="n">predict_p</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">NUM_ACTIONS</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">train()</code> method receives samples, processes them and pushes them into the training queue. First, it turns actions into one hot encoded array needed later. Then it stores the current transition in an internal memory, which is used to compute the n-step return.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s_</span><span class="p">):</span>   
        <span class="n">a_cats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NUM_ACTIONS</span><span class="p">)</span>
        <span class="n">a_cats</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a_cats</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s_</span><span class="p">)</span> <span class="p">)</span>
</code></pre></div></div>

<p>Last <em>n</em> samples are stored in this buffer and when there are enough of them, n-step discounted reward <code class="language-plaintext highlighter-rouge">R</code> is computed. Proper variables are retrieved and a tuple <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-5-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mi&gt;R&lt;/mi&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-107" style="width: 6.712em; display: inline-block;"><span style="display: inline-block; position: relative; width: 5.729em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1005.64em, 2.652em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-108"><span class="mo" id="MathJax-Span-109" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-110"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-111" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-112" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-113" style="font-family: MathJax_Main;">,</span><span class="msubsup" id="MathJax-Span-114" style="padding-left: 0.173em;"><span style="display: inline-block; position: relative; width: 0.942em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.51em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-115" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.515em;"><span class="mn" id="MathJax-Span-116" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-117" style="font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-118" style="font-family: MathJax_Math-italic; padding-left: 0.173em;">R</span><span class="mo" id="MathJax-Span-119" style="font-family: MathJax_Main;">,</span><span class="msubsup" id="MathJax-Span-120" style="padding-left: 0.173em;"><span style="display: inline-block; position: relative; width: 0.985em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-121" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mi" id="MathJax-Span-122" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-123" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.252em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo stretchy="false">(</mo><msub><mi>s</mi><mn>0</mn></msub><mo>,</mo><msub><mi>a</mi><mn>0</mn></msub><mo>,</mo><mi>R</mi><mo>,</mo><msub><mi>s</mi><mi>n</mi></msub><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-5">(s_0, a_0, R, s_n)</script> is inserted into the brain’s training queue.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">N_STEP_RETURN</span><span class="p">:</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s_</span> <span class="o">=</span> <span class="n">get_sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span> <span class="n">N_STEP_RETURN</span><span class="p">)</span>
            <span class="n">brain</span><span class="o">.</span><span class="n">train_push</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s_</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>      
</code></pre></div></div>

<p>An internal <code class="language-plaintext highlighter-rouge">get_sample()</code> function is responsible to compute n-step discounted reward and return a proper tuple:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">def</span> <span class="nf">get_sample</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">r</span> <span class="o">+=</span> <span class="n">memory</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">GAMMA</span> <span class="o">**</span> <span class="n">i</span><span class="p">)</span>

            <span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span>  <span class="o">=</span> <span class="n">memory</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">s_</span> <span class="o">=</span> <span class="n">memory</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s_</span>
</code></pre></div></div>

<p>The last thing we have to deal with is the case when our agent encounters a terminal state. As there will be no more states after, we have to deplete the whole buffer. In loop, we shorten the buffer in each iteration and compute the n-step return, where <em>n</em> is equal to the current length of the buffer.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">if</span> <span class="n">s_</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>      <span class="c1"># terminal state
</span>            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span>
                <span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s_</span> <span class="o">=</span> <span class="n">get_sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                <span class="n">brain</span><span class="o">.</span><span class="n">train_push</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s_</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  
</code></pre></div></div>

<h4 id="effective-implementation">Effective implementation</h4>
<p>You might have noticed that we are looping over the whole memory within each step to compute the discounted reward. While this implementation is good for demonstration and understanding, it is clearly inefficient. Let’s look at the discounted reward formula:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-6-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;msub&gt;&lt;mi&gt;R&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-124" style="width: 18.763em; display: inline-block;"><span style="display: inline-block; position: relative; width: 16.028em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.241em, 1016.03em, 2.609em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-125"><span class="msubsup" id="MathJax-Span-126"><span style="display: inline-block; position: relative; width: 1.199em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.77em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-127" style="font-family: MathJax_Math-italic;">R</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.771em;"><span class="mn" id="MathJax-Span-128" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-129" style="font-family: MathJax_Main; padding-left: 0.301em;">=</span><span class="msubsup" id="MathJax-Span-130" style="padding-left: 0.301em;"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-131" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-132" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-133" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="mi" id="MathJax-Span-134" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span class="msubsup" id="MathJax-Span-135"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-136" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-137" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-138" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="msubsup" id="MathJax-Span-139" style="padding-left: 0.216em;"><span style="display: inline-block; position: relative; width: 1.028em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-140" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="mn" id="MathJax-Span-141" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-142"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-143" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-144" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-145" style="font-family: MathJax_Main;">+</span><span class="mo" id="MathJax-Span-146" style="font-family: MathJax_Main;">.</span><span class="mo" id="MathJax-Span-147" style="font-family: MathJax_Main; padding-left: 0.173em;">.</span><span class="mo" id="MathJax-Span-148" style="font-family: MathJax_Main; padding-left: 0.173em;">.</span><span class="mo" id="MathJax-Span-149" style="font-family: MathJax_Main; padding-left: 0.173em;">+</span><span class="msubsup" id="MathJax-Span-150"><span style="display: inline-block; position: relative; width: 2.011em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-151" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="texatom" id="MathJax-Span-152"><span class="mrow" id="MathJax-Span-153"><span class="mi" id="MathJax-Span-154" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span class="mo" id="MathJax-Span-155" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-156" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-157"><span style="display: inline-block; position: relative; width: 1.84em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-158" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="texatom" id="MathJax-Span-159"><span class="mrow" id="MathJax-Span-160"><span class="mi" id="MathJax-Span-161" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span class="mo" id="MathJax-Span-162" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-163" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.297em; border-left: 0px solid; width: 0px; height: 1.403em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mi>R</mi><mn>0</mn></msub><mo>=</mo><msub><mi>r</mi><mn>0</mn></msub><mo>+</mo><mi>γ</mi><msub><mi>r</mi><mn>1</mn></msub><mo>+</mo><msup><mi>γ</mi><mn>2</mn></msup><msub><mi>r</mi><mn>2</mn></msub><mo>+</mo><mo>.</mo><mo>.</mo><mo>.</mo><mo>+</mo><msup><mi>γ</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msup><msub><mi>r</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-6">R_0 = r_0 + \gamma r_1 + \gamma^2 r_2 + ... + \gamma^{n-1} r_{n-1}</script>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-7-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;msub&gt;&lt;mi&gt;R&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;3&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-164" style="width: 17.694em; display: inline-block;"><span style="display: inline-block; position: relative; width: 15.13em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.241em, 1015.13em, 2.609em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-165"><span class="msubsup" id="MathJax-Span-166"><span style="display: inline-block; position: relative; width: 1.199em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.77em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-167" style="font-family: MathJax_Math-italic;">R</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.771em;"><span class="mn" id="MathJax-Span-168" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-169" style="font-family: MathJax_Main; padding-left: 0.301em;">=</span><span class="msubsup" id="MathJax-Span-170" style="padding-left: 0.301em;"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-171" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-172" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-173" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="mi" id="MathJax-Span-174" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span class="msubsup" id="MathJax-Span-175"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-176" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-177" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-178" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="msubsup" id="MathJax-Span-179" style="padding-left: 0.216em;"><span style="display: inline-block; position: relative; width: 1.028em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-180" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="mn" id="MathJax-Span-181" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-182"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-183" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-184" style="font-size: 70.7%; font-family: MathJax_Main;">3</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-185" style="font-family: MathJax_Main;">+</span><span class="mo" id="MathJax-Span-186" style="font-family: MathJax_Main;">.</span><span class="mo" id="MathJax-Span-187" style="font-family: MathJax_Main; padding-left: 0.173em;">.</span><span class="mo" id="MathJax-Span-188" style="font-family: MathJax_Main; padding-left: 0.173em;">.</span><span class="mo" id="MathJax-Span-189" style="font-family: MathJax_Main; padding-left: 0.173em;">+</span><span class="msubsup" id="MathJax-Span-190"><span style="display: inline-block; position: relative; width: 2.011em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-191" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="texatom" id="MathJax-Span-192"><span class="mrow" id="MathJax-Span-193"><span class="mi" id="MathJax-Span-194" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span class="mo" id="MathJax-Span-195" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-196" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-197"><span style="display: inline-block; position: relative; width: 0.942em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-198" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="texatom" id="MathJax-Span-199"><span class="mrow" id="MathJax-Span-200"><span class="mi" id="MathJax-Span-201" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.297em; border-left: 0px solid; width: 0px; height: 1.403em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mi>R</mi><mn>1</mn></msub><mo>=</mo><msub><mi>r</mi><mn>1</mn></msub><mo>+</mo><mi>γ</mi><msub><mi>r</mi><mn>2</mn></msub><mo>+</mo><msup><mi>γ</mi><mn>2</mn></msup><msub><mi>r</mi><mn>3</mn></msub><mo>+</mo><mo>.</mo><mo>.</mo><mo>.</mo><mo>+</mo><msup><mi>γ</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msup><msub><mi>r</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi></mrow></msub></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-7">R_1 = r_1 + \gamma r_2 + \gamma^2 r_3 + ... + \gamma^{n-1} r_{n}</script>

<p>We can see a relationship:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-8-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;msub&gt;&lt;mi&gt;R&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;msub&gt;&lt;mi&gt;R&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;/mfrac&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-202" style="width: 12.182em; display: inline-block;"><span style="display: inline-block; position: relative; width: 10.387em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(0.771em, 1010.39em, 3.293em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-203"><span class="msubsup" id="MathJax-Span-204"><span style="display: inline-block; position: relative; width: 1.199em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.77em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-205" style="font-family: MathJax_Math-italic;">R</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.771em;"><span class="mn" id="MathJax-Span-206" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-207" style="font-family: MathJax_Main; padding-left: 0.301em;">=</span><span class="mfrac" id="MathJax-Span-208" style="padding-left: 0.301em;"><span style="display: inline-block; position: relative; width: 3.378em; height: 0px; margin-right: 0.13em; margin-left: 0.13em;"><span style="position: absolute; clip: rect(3.207em, 1003.29em, 4.318em, -999.998em); top: -4.699em; left: 50%; margin-left: -1.622em;"><span class="mrow" id="MathJax-Span-209"><span class="msubsup" id="MathJax-Span-210"><span style="display: inline-block; position: relative; width: 1.199em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.77em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-211" style="font-family: MathJax_Math-italic;">R</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.771em;"><span class="mn" id="MathJax-Span-212" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-213" style="font-family: MathJax_Main; padding-left: 0.216em;">−</span><span class="msubsup" id="MathJax-Span-214" style="padding-left: 0.216em;"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-215" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-216" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -3.331em; left: 50%; margin-left: -0.254em;"><span class="mi" id="MathJax-Span-217" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(0.9em, 1003.38em, 1.199em, -999.998em); top: -1.28em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.4px solid; width: 3.378em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.071em;"></span></span></span></span><span class="mo" id="MathJax-Span-218" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="msubsup" id="MathJax-Span-219" style="padding-left: 0.216em;"><span style="display: inline-block; position: relative; width: 2.011em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-220" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="texatom" id="MathJax-Span-221"><span class="mrow" id="MathJax-Span-222"><span class="mi" id="MathJax-Span-223" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span class="mo" id="MathJax-Span-224" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-225" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-226"><span style="display: inline-block; position: relative; width: 0.942em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-227" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mi" id="MathJax-Span-228" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -1.097em; border-left: 0px solid; width: 0px; height: 2.752em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mi>R</mi><mn>1</mn></msub><mo>=</mo><mfrac><mrow><msub><mi>R</mi><mn>0</mn></msub><mo>−</mo><msub><mi>r</mi><mn>0</mn></msub></mrow><mi>γ</mi></mfrac><mo>+</mo><msup><mi>γ</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msup><msub><mi>r</mi><mi>n</mi></msub></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-8">R_1 = \frac{R_0 - r_0}{\gamma} + \gamma^{n-1} r_n</script>

<p>So we can remember the value of R and update it accordingly with each time step. This implementation is used in the actual accompanying code.</p>

<h3 id="brain">Brain</h3>
<p>The <code class="language-plaintext highlighter-rouge">Brain</code> class encapsulates the neural network, TensorFlow graph definition and related computation. Let’s look at its parts in order.</p>

<h4 id="training-queue">Training queue</h4>
<p>One of the responsibilities of the <code class="language-plaintext highlighter-rouge">Brain</code> class is to hold a training queue. This queue consists of 5 arrays - starting state <code class="language-plaintext highlighter-rouge">s</code>, one-hot encoded taken action <code class="language-plaintext highlighter-rouge">a</code>, discounted n-step return <code class="language-plaintext highlighter-rouge">r</code>, landing state after <em>n</em> steps <code class="language-plaintext highlighter-rouge">s_</code> and a terminal mask with values <code class="language-plaintext highlighter-rouge">1.</code> or <code class="language-plaintext highlighter-rouge">0.</code>, indicating whether the <code class="language-plaintext highlighter-rouge">s_</code> is <code class="language-plaintext highlighter-rouge">None</code> or not. Terminal mask will be useful later to parallelize the computation.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">train_push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s_</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_queue</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_queue</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_queue</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">s_</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_queue</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NONE_STATE</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_queue</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>   
                <span class="bp">self</span><span class="o">.</span><span class="n">train_queue</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_queue</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span>
</code></pre></div></div>

<p>Also a dummy <code class="language-plaintext highlighter-rouge">NONE_STATE</code> is used in case the <code class="language-plaintext highlighter-rouge">s_</code> is <code class="language-plaintext highlighter-rouge">None</code>. This dummy state is valid, so it can be processed by the neural network, but we don’t care about the result. It’s only there to parallelize the computation.</p>

<p>The samples from agents are gathered in the training queue through <code class="language-plaintext highlighter-rouge">train_push()</code> method in a synchronized manner.</p>

<h4 id="neural-network">Neural network</h4>
<p>The core of our new agent is a neural network that decides what to do in a given situation. There are two sets of outputs - the policy itself and the value function.</p>

<p><img class="w50" src="./A3C_ Implementation_files/a3c_nn_2.png" alt="Neural network architecture"></p>

<p>It is defined very easily with Keras:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">l_input</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span> <span class="n">batch_shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">NUM_STATE</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">l_dense</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">l_input</span><span class="p">)</span>

    <span class="n">out_actions</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">NUM_ACTIONS</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'softmax'</span><span class="p">)(</span><span class="n">l_dense</span><span class="p">)</span>
    <span class="n">out_value</span>   <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'linear'</span><span class="p">)(</span><span class="n">l_dense</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">l_input</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">out_actions</span><span class="p">,</span> <span class="n">out_value</span><span class="p">])</span>
</code></pre></div></div>

<p>The policy output goes through softmax activation to make it correct probability distribution. The ouput for value function is linear, as we need all values to be possible.</p>

<h4 id="loss-function">Loss function</h4>
<p>Now we have to define a loss function, which has three parts:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-9-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mi&gt;v&lt;/mi&gt;&lt;/msub&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mi&gt;v&lt;/mi&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;g&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;g&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-229" style="width: 12.694em; display: inline-block;"><span style="display: inline-block; position: relative; width: 10.857em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.455em, 1010.86em, 2.694em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-230"><span class="mi" id="MathJax-Span-231" style="font-family: MathJax_Math-italic;">L</span><span class="mo" id="MathJax-Span-232" style="font-family: MathJax_Main; padding-left: 0.301em;">=</span><span class="msubsup" id="MathJax-Span-233" style="padding-left: 0.301em;"><span style="display: inline-block; position: relative; width: 1.156em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.64em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-234" style="font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.686em;"><span class="texatom" id="MathJax-Span-235"><span class="mrow" id="MathJax-Span-236"><span class="mi" id="MathJax-Span-237" style="font-size: 70.7%; font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-238" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="msubsup" id="MathJax-Span-239" style="padding-left: 0.216em;"><span style="display: inline-block; position: relative; width: 0.857em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-240" style="font-family: MathJax_Math-italic;">c</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.429em;"><span class="mi" id="MathJax-Span-241" style="font-size: 70.7%; font-family: MathJax_Math-italic;">v</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-242"><span style="display: inline-block; position: relative; width: 1.113em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.64em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-243" style="font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.686em;"><span class="mi" id="MathJax-Span-244" style="font-size: 70.7%; font-family: MathJax_Math-italic;">v</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-245" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="msubsup" id="MathJax-Span-246" style="padding-left: 0.216em;"><span style="display: inline-block; position: relative; width: 1.498em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-247" style="font-family: MathJax_Math-italic;">c</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.429em;"><span class="texatom" id="MathJax-Span-248"><span class="mrow" id="MathJax-Span-249"><span class="mi" id="MathJax-Span-250" style="font-size: 70.7%; font-family: MathJax_Math-italic;">r</span><span class="mi" id="MathJax-Span-251" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span class="mi" id="MathJax-Span-252" style="font-size: 70.7%; font-family: MathJax_Math-italic;">g<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-253"><span style="display: inline-block; position: relative; width: 1.754em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.64em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-254" style="font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.686em;"><span class="texatom" id="MathJax-Span-255"><span class="mrow" id="MathJax-Span-256"><span class="mi" id="MathJax-Span-257" style="font-size: 70.7%; font-family: MathJax_Math-italic;">r</span><span class="mi" id="MathJax-Span-258" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span class="mi" id="MathJax-Span-259" style="font-size: 70.7%; font-family: MathJax_Math-italic;">g<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.398em; border-left: 0px solid; width: 0px; height: 1.252em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>L</mi><mo>=</mo><msub><mi>L</mi><mrow class="MJX-TeXAtom-ORD"><mi>π</mi></mrow></msub><mo>+</mo><msub><mi>c</mi><mi>v</mi></msub><msub><mi>L</mi><mi>v</mi></msub><mo>+</mo><msub><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mi>r</mi><mi>e</mi><mi>g</mi></mrow></msub><msub><mi>L</mi><mrow class="MJX-TeXAtom-ORD"><mi>r</mi><mi>e</mi><mi>g</mi></mrow></msub></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-9">L = L_{\pi} + c_v L_v + c_{reg} L_{reg}</script>

<p><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-10-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-260" style="width: 1.37em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.156em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1001.16em, 2.481em, -999.998em); top: -2.177em; left: 0em;"><span class="mrow" id="MathJax-Span-261"><span class="msubsup" id="MathJax-Span-262"><span style="display: inline-block; position: relative; width: 1.156em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.64em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-263" style="font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.686em;"><span class="texatom" id="MathJax-Span-264"><span class="mrow" id="MathJax-Span-265"><span class="mi" id="MathJax-Span-266" style="font-size: 70.7%; font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.182em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.103em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>L</mi><mrow class="MJX-TeXAtom-ORD"><mi>π</mi></mrow></msub></math></span></span><script type="math/tex" id="MathJax-Element-10">L_{\pi}</script> is the loss of the policy, <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-11-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mi&gt;v&lt;/mi&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-267" style="width: 1.327em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.113em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1001.11em, 2.481em, -999.998em); top: -2.177em; left: 0em;"><span class="mrow" id="MathJax-Span-268"><span class="msubsup" id="MathJax-Span-269"><span style="display: inline-block; position: relative; width: 1.113em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.64em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-270" style="font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.686em;"><span class="mi" id="MathJax-Span-271" style="font-size: 70.7%; font-family: MathJax_Math-italic;">v</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.182em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.103em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>L</mi><mi>v</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-11">L_v</script> is the value error and <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-12-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;g&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-272" style="width: 2.053em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.754em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1001.75em, 2.609em, -999.998em); top: -2.177em; left: 0em;"><span class="mrow" id="MathJax-Span-273"><span class="msubsup" id="MathJax-Span-274"><span style="display: inline-block; position: relative; width: 1.754em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.64em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-275" style="font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.686em;"><span class="texatom" id="MathJax-Span-276"><span class="mrow" id="MathJax-Span-277"><span class="mi" id="MathJax-Span-278" style="font-size: 70.7%; font-family: MathJax_Math-italic;">r</span><span class="mi" id="MathJax-Span-279" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span class="mi" id="MathJax-Span-280" style="font-size: 70.7%; font-family: MathJax_Math-italic;">g<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.182em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.398em; border-left: 0px solid; width: 0px; height: 1.252em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>L</mi><mrow class="MJX-TeXAtom-ORD"><mi>r</mi><mi>e</mi><mi>g</mi></mrow></msub></math></span></span><script type="math/tex" id="MathJax-Element-12">L_{reg}</script> is a regularization term. These parts are multiplied by constants <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-13-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mi&gt;v&lt;/mi&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-281" style="width: 1.028em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.857em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.626em, 1000.86em, 2.481em, -999.998em); top: -2.177em; left: 0em;"><span class="mrow" id="MathJax-Span-282"><span class="msubsup" id="MathJax-Span-283"><span style="display: inline-block; position: relative; width: 0.857em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-284" style="font-family: MathJax_Math-italic;">c</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.429em;"><span class="mi" id="MathJax-Span-285" style="font-size: 70.7%; font-family: MathJax_Math-italic;">v</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.182em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.802em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>c</mi><mi>v</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-13">c_v</script> and <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-14-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;g&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-286" style="width: 1.754em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.498em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.626em, 1001.5em, 2.609em, -999.998em); top: -2.177em; left: 0em;"><span class="mrow" id="MathJax-Span-287"><span class="msubsup" id="MathJax-Span-288"><span style="display: inline-block; position: relative; width: 1.498em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-289" style="font-family: MathJax_Math-italic;">c</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.429em;"><span class="texatom" id="MathJax-Span-290"><span class="mrow" id="MathJax-Span-291"><span class="mi" id="MathJax-Span-292" style="font-size: 70.7%; font-family: MathJax_Math-italic;">r</span><span class="mi" id="MathJax-Span-293" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span class="mi" id="MathJax-Span-294" style="font-size: 70.7%; font-family: MathJax_Math-italic;">g<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.182em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.398em; border-left: 0px solid; width: 0px; height: 0.953em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mi>r</mi><mi>e</mi><mi>g</mi></mrow></msub></math></span></span><script type="math/tex" id="MathJax-Element-14">c_{reg}</script>, which determine what part we stress more. Let’s describe these in order.</p>

<h4 id="policy-loss">Policy Loss</h4>
<p>We defined an objective function <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-15-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;J&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-295" style="width: 2.31em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.968em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1001.88em, 2.652em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-296"><span class="mi" id="MathJax-Span-297" style="font-family: MathJax_Math-italic;">J<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.088em;"></span></span><span class="mo" id="MathJax-Span-298" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-299" style="font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mo" id="MathJax-Span-300" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.252em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>J</mi><mo stretchy="false">(</mo><mi>π</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-15">J(\pi)</script> as total reward an agent can achieve under policy <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-16-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-301" style="width: 0.729em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.6em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.626em, 1000.6em, 2.31em, -999.998em); top: -2.177em; left: 0em;"><span class="mrow" id="MathJax-Span-302"><span class="mi" id="MathJax-Span-303" style="font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.182em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.048em; border-left: 0px solid; width: 0px; height: 0.603em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>π</mi></math></span></span><script type="math/tex" id="MathJax-Element-16">\pi</script> averaged over all starting states:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-17-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mi&gt;J&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;E&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03C1;&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;[&lt;/mo&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo stretchy=&quot;false&quot;&gt;]&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-304" style="width: 9.532em; display: inline-block;"><span style="display: inline-block; position: relative; width: 8.122em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1007.99em, 2.694em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-305"><span class="mi" id="MathJax-Span-306" style="font-family: MathJax_Math-italic;">J<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.088em;"></span></span><span class="mo" id="MathJax-Span-307" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-308" style="font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mo" id="MathJax-Span-309" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-310" style="font-family: MathJax_Main; padding-left: 0.301em;">=</span><span class="msubsup" id="MathJax-Span-311" style="padding-left: 0.301em;"><span style="display: inline-block; position: relative; width: 1.754em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.77em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-312" style="font-family: MathJax_Math-italic;">E<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.729em;"><span class="texatom" id="MathJax-Span-313"><span class="mrow" id="MathJax-Span-314"><span class="msubsup" id="MathJax-Span-315"><span style="display: inline-block; position: relative; width: 0.942em; height: 0px;"><span style="position: absolute; clip: rect(3.592em, 1000.34em, 4.318em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-316" style="font-size: 70.7%; font-family: MathJax_Math-italic;">ρ</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.271em; left: 0.387em;"><span class="texatom" id="MathJax-Span-317"><span class="mrow" id="MathJax-Span-318"><span class="msubsup" id="MathJax-Span-319"><span style="display: inline-block; position: relative; width: 0.515em; height: 0px;"><span style="position: absolute; clip: rect(3.677em, 1000.22em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-320" style="font-size: 50%; font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.216em;"><span class="mn" id="MathJax-Span-321" style="font-size: 50%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-322" style="font-family: MathJax_Main;">[</span><span class="mi" id="MathJax-Span-323" style="font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-324" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-325"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-326" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-327" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-328" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-329" style="font-family: MathJax_Main;">]</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.398em; border-left: 0px solid; width: 0px; height: 1.353em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>J</mi><mo stretchy="false">(</mo><mi>π</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>E</mi><mrow class="MJX-TeXAtom-ORD"><msup><mi>ρ</mi><mrow class="MJX-TeXAtom-ORD"><msub><mi>s</mi><mn>0</mn></msub></mrow></msup></mrow></msub><mo stretchy="false">[</mo><mi>V</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mn>0</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">]</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-17">J(\pi) = E_{\rho^{s_0}}[V(s_0)]</script>

<p>We also know that a gradient of this function is determined by <em>Policy Gradient Theorem</em> as:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-18-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;msub&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;&amp;#x2207;&lt;/mi&gt;&lt;mi&gt;&amp;#x03B8;&lt;/mi&gt;&lt;/msub&gt;&lt;mspace width=&quot;thickmathspace&quot; /&gt;&lt;mi&gt;J&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;E&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo&gt;&amp;#x223C;&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03C1;&lt;/mi&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;/msup&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mspace width=&quot;thickmathspace&quot; /&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mo&gt;&amp;#x223C;&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;[&lt;/mo&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;&amp;#x22C5;&lt;/mo&gt;&lt;msub&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;&amp;#x2207;&lt;/mi&gt;&lt;mi&gt;&amp;#x03B8;&lt;/mi&gt;&lt;/msub&gt;&lt;mspace width=&quot;thickmathspace&quot; /&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;g&lt;/mi&gt;&lt;mspace width=&quot;thickmathspace&quot; /&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mo fence=&quot;false&quot; stretchy=&quot;false&quot;&gt;&amp;#x2016;&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo stretchy=&quot;false&quot;&gt;]&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-330" style="width: 23.677em; display: inline-block;"><span style="display: inline-block; position: relative; width: 20.216em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1020.09em, 2.737em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-331"><span class="msubsup" id="MathJax-Span-332"><span style="display: inline-block; position: relative; width: 1.241em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.77em, 4.19em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-333" style="font-family: MathJax_Main;">∇</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.814em;"><span class="mi" id="MathJax-Span-334" style="font-size: 70.7%; font-family: MathJax_Math-italic;">θ</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mspace" id="MathJax-Span-335" style="height: 0em; vertical-align: 0em; width: 0.301em; display: inline-block; overflow: hidden;"></span><span class="mi" id="MathJax-Span-336" style="font-family: MathJax_Math-italic;">J<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.088em;"></span></span><span class="mo" id="MathJax-Span-337" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-338" style="font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mo" id="MathJax-Span-339" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-340" style="font-family: MathJax_Main; padding-left: 0.301em;">=</span><span class="msubsup" id="MathJax-Span-341" style="padding-left: 0.301em;"><span style="display: inline-block; position: relative; width: 5.088em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.77em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-342" style="font-family: MathJax_Math-italic;">E<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.729em;"><span class="texatom" id="MathJax-Span-343"><span class="mrow" id="MathJax-Span-344"><span class="mi" id="MathJax-Span-345" style="font-size: 70.7%; font-family: MathJax_Math-italic;">s</span><span class="mo" id="MathJax-Span-346" style="font-size: 70.7%; font-family: MathJax_Main;">∼</span><span class="msubsup" id="MathJax-Span-347"><span style="display: inline-block; position: relative; width: 0.686em; height: 0px;"><span style="position: absolute; clip: rect(3.592em, 1000.34em, 4.318em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-348" style="font-size: 70.7%; font-family: MathJax_Math-italic;">ρ</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.229em; left: 0.387em;"><span class="mi" id="MathJax-Span-349" style="font-size: 50%; font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-350" style="font-size: 70.7%; font-family: MathJax_Main;">,</span><span class="mspace" id="MathJax-Span-351" style="height: 0em; vertical-align: 0em; width: 0.301em; display: inline-block; overflow: hidden;"></span><span class="mi" id="MathJax-Span-352" style="font-size: 70.7%; font-family: MathJax_Math-italic;">a</span><span class="mo" id="MathJax-Span-353" style="font-size: 70.7%; font-family: MathJax_Main;">∼</span><span class="texatom" id="MathJax-Span-354"><span class="mrow" id="MathJax-Span-355"><span class="mi" id="MathJax-Span-356" style="font-size: 70.7%; font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mo" id="MathJax-Span-357" style="font-size: 70.7%; font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-358" style="font-size: 70.7%; font-family: MathJax_Math-italic;">s</span><span class="mo" id="MathJax-Span-359" style="font-size: 70.7%; font-family: MathJax_Main;">)</span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-360" style="font-family: MathJax_Main;">[</span><span class="mi" id="MathJax-Span-361" style="font-family: MathJax_Math-italic;">A</span><span class="mo" id="MathJax-Span-362" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-363" style="font-family: MathJax_Math-italic;">s</span><span class="mo" id="MathJax-Span-364" style="font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-365" style="font-family: MathJax_Math-italic; padding-left: 0.173em;">a</span><span class="mo" id="MathJax-Span-366" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-367" style="font-family: MathJax_Main; padding-left: 0.216em;">⋅</span><span class="msubsup" id="MathJax-Span-368" style="padding-left: 0.216em;"><span style="display: inline-block; position: relative; width: 1.241em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.77em, 4.19em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-369" style="font-family: MathJax_Main;">∇</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.814em;"><span class="mi" id="MathJax-Span-370" style="font-size: 70.7%; font-family: MathJax_Math-italic;">θ</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mspace" id="MathJax-Span-371" style="height: 0em; vertical-align: 0em; width: 0.301em; display: inline-block; overflow: hidden;"></span><span class="mi" id="MathJax-Span-372" style="font-family: MathJax_Math-italic;">l</span><span class="mi" id="MathJax-Span-373" style="font-family: MathJax_Math-italic;">o</span><span class="mi" id="MathJax-Span-374" style="font-family: MathJax_Math-italic;">g<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mspace" id="MathJax-Span-375" style="height: 0em; vertical-align: 0em; width: 0.301em; display: inline-block; overflow: hidden;"></span><span class="mi" id="MathJax-Span-376" style="font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mo" id="MathJax-Span-377" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-378" style="font-family: MathJax_Math-italic;">a</span><span class="mo" id="MathJax-Span-379" style="font-family: MathJax_Main;">∥</span><span class="mi" id="MathJax-Span-380" style="font-family: MathJax_Math-italic;">s</span><span class="mo" id="MathJax-Span-381" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-382" style="font-family: MathJax_Main;">]</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.447em; border-left: 0px solid; width: 0px; height: 1.403em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mi mathvariant="normal">∇</mi><mi>θ</mi></msub><mspace width="thickmathspace"></mspace><mi>J</mi><mo stretchy="false">(</mo><mi>π</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>E</mi><mrow class="MJX-TeXAtom-ORD"><mi>s</mi><mo>∼</mo><msup><mi>ρ</mi><mi>π</mi></msup><mo>,</mo><mspace width="thickmathspace"></mspace><mi>a</mi><mo>∼</mo><mrow class="MJX-TeXAtom-ORD"><mi>π</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></mrow></mrow></msub><mo stretchy="false">[</mo><mi>A</mi><mo stretchy="false">(</mo><mi>s</mi><mo>,</mo><mi>a</mi><mo stretchy="false">)</mo><mo>⋅</mo><msub><mi mathvariant="normal">∇</mi><mi>θ</mi></msub><mspace width="thickmathspace"></mspace><mi>l</mi><mi>o</mi><mi>g</mi><mspace width="thickmathspace"></mspace><mi>π</mi><mo stretchy="false">(</mo><mi>a</mi><mo fence="false" stretchy="false">‖</mo><mi>s</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-18">\nabla_\theta\;J(\pi) = E_{s\sim\rho^\pi,\;a\sim{\pi(s)}}[ A(s, a) \cdot \nabla_\theta\;log\;\pi(a\|s) ]</script>

<p>We are trying to maximize the <em>J</em> function, so we can just say that:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-19-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;/msub&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mi&gt;J&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-383" style="width: 6.199em; display: inline-block;"><span style="display: inline-block; position: relative; width: 5.301em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1005.22em, 2.652em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-384"><span class="msubsup" id="MathJax-Span-385"><span style="display: inline-block; position: relative; width: 1.156em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.64em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-386" style="font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.686em;"><span class="mi" id="MathJax-Span-387" style="font-size: 70.7%; font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-388" style="font-family: MathJax_Main; padding-left: 0.301em;">=</span><span class="mo" id="MathJax-Span-389" style="font-family: MathJax_Main; padding-left: 0.301em;">−</span><span class="mi" id="MathJax-Span-390" style="font-family: MathJax_Math-italic;">J<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.088em;"></span></span><span class="mo" id="MathJax-Span-391" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-392" style="font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mo" id="MathJax-Span-393" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.252em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mi>L</mi><mi>π</mi></msub><mo>=</mo><mo>−</mo><mi>J</mi><mo stretchy="false">(</mo><mi>π</mi><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-19">L_\pi = -J(\pi)</script>

<p>However, TensorFlow can’t analytically compute gradient of this function, so we have to help it with our knowledge. We can rewrite the definition of function <em>J</em> as follows, while treating the <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-20-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;munder&gt;&lt;mrow&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;mo&gt;&amp;#x005F;&lt;/mo&gt;&lt;/munder&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-394" style="width: 3.506em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.994em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.284em, 1002.99em, 2.78em, -999.998em); top: -2.177em; left: 0em;"><span class="mrow" id="MathJax-Span-395"><span class="munderover" id="MathJax-Span-396"><span style="display: inline-block; position: relative; width: 2.994em; height: 0px;"><span style="position: absolute; clip: rect(3.122em, 1002.87em, 4.404em, -999.998em); top: -4.015em; left: 0.002em;"><span class="mrow" id="MathJax-Span-397"><span class="mi" id="MathJax-Span-398" style="font-family: MathJax_Math-italic;">A</span><span class="mo" id="MathJax-Span-399" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-400" style="font-family: MathJax_Math-italic;">s</span><span class="mo" id="MathJax-Span-401" style="font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-402" style="font-family: MathJax_Math-italic; padding-left: 0.173em;">a</span><span class="mo" id="MathJax-Span-403" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.635em, 1002.99em, 3.934em, -999.998em); top: -3.331em; left: 0em;"><span class="mo" id="MathJax-Span-404" style=""><span style="display: inline-block; position: relative; width: 2.994em; height: 0px;"><span style="position: absolute; font-family: MathJax_Main; top: -4.015em; left: -0.083em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; font-family: MathJax_Main; top: -4.015em; left: 2.31em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 0.387em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 0.857em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 1.327em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 1.84em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.182em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.597em; border-left: 0px solid; width: 0px; height: 1.552em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><munder><mrow><mi>A</mi><mo stretchy="false">(</mo><mi>s</mi><mo>,</mo><mi>a</mi><mo stretchy="false">)</mo></mrow><mo>_</mo></munder></math></span></span><script type="math/tex" id="MathJax-Element-20">\underline{A(s, a)}</script> part as a constant:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-21-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mi&gt;J&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mi&gt;E&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;[&lt;/mo&gt;&lt;munder&gt;&lt;mrow&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;mo&gt;&amp;#x005F;&lt;/mo&gt;&lt;/munder&gt;&lt;mo&gt;&amp;#x22C5;&lt;/mo&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;g&lt;/mi&gt;&lt;mspace width=&quot;thickmathspace&quot; /&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mo fence=&quot;false&quot; stretchy=&quot;false&quot;&gt;&amp;#x2016;&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo stretchy=&quot;false&quot;&gt;]&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-405" style="width: 15.002em; display: inline-block;"><span style="display: inline-block; position: relative; width: 12.823em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1012.69em, 2.865em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-406"><span class="mi" id="MathJax-Span-407" style="font-family: MathJax_Math-italic;">J<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.088em;"></span></span><span class="mo" id="MathJax-Span-408" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-409" style="font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mo" id="MathJax-Span-410" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-411" style="font-family: MathJax_Main; padding-left: 0.301em;">=</span><span class="mi" id="MathJax-Span-412" style="font-family: MathJax_Math-italic; padding-left: 0.301em;">E<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span class="mo" id="MathJax-Span-413" style="font-family: MathJax_Main;">[</span><span class="munderover" id="MathJax-Span-414"><span style="display: inline-block; position: relative; width: 2.994em; height: 0px;"><span style="position: absolute; clip: rect(3.122em, 1002.87em, 4.404em, -999.998em); top: -4.015em; left: 0.002em;"><span class="mrow" id="MathJax-Span-415"><span class="mi" id="MathJax-Span-416" style="font-family: MathJax_Math-italic;">A</span><span class="mo" id="MathJax-Span-417" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-418" style="font-family: MathJax_Math-italic;">s</span><span class="mo" id="MathJax-Span-419" style="font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-420" style="font-family: MathJax_Math-italic; padding-left: 0.173em;">a</span><span class="mo" id="MathJax-Span-421" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.635em, 1002.99em, 3.934em, -999.998em); top: -3.331em; left: 0em;"><span class="mo" id="MathJax-Span-422" style=""><span style="display: inline-block; position: relative; width: 2.994em; height: 0px;"><span style="position: absolute; font-family: MathJax_Main; top: -4.015em; left: -0.083em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; font-family: MathJax_Main; top: -4.015em; left: 2.31em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 0.387em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 0.857em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 1.327em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 1.84em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-423" style="font-family: MathJax_Main; padding-left: 0.216em;">⋅</span><span class="mi" id="MathJax-Span-424" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">l</span><span class="mi" id="MathJax-Span-425" style="font-family: MathJax_Math-italic;">o</span><span class="mi" id="MathJax-Span-426" style="font-family: MathJax_Math-italic;">g<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mspace" id="MathJax-Span-427" style="height: 0em; vertical-align: 0em; width: 0.301em; display: inline-block; overflow: hidden;"></span><span class="mi" id="MathJax-Span-428" style="font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mo" id="MathJax-Span-429" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-430" style="font-family: MathJax_Math-italic;">a</span><span class="mo" id="MathJax-Span-431" style="font-family: MathJax_Main;">∥</span><span class="mi" id="MathJax-Span-432" style="font-family: MathJax_Math-italic;">s</span><span class="mo" id="MathJax-Span-433" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-434" style="font-family: MathJax_Main;">]</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.597em; border-left: 0px solid; width: 0px; height: 1.552em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>J</mi><mo stretchy="false">(</mo><mi>π</mi><mo stretchy="false">)</mo><mo>=</mo><mi>E</mi><mo stretchy="false">[</mo><munder><mrow><mi>A</mi><mo stretchy="false">(</mo><mi>s</mi><mo>,</mo><mi>a</mi><mo stretchy="false">)</mo></mrow><mo>_</mo></munder><mo>⋅</mo><mi>l</mi><mi>o</mi><mi>g</mi><mspace width="thickmathspace"></mspace><mi>π</mi><mo stretchy="false">(</mo><mi>a</mi><mo fence="false" stretchy="false">‖</mo><mi>s</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-21">J(\pi) = E [\underline{A(s, a)} \cdot log\;\pi(a\|s)]</script>

<p>This expression can be automatically differentiated by TensorFlow resulting in the same formula as given by the Policy Gradient Theorem.</p>

<p>For completeness, we have to swap the expectation for average over all samples in a batch. We are using samples generated by policy π and therefore can make this switch. The final loss function is then:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-22-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;/msub&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mfrac&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mfrac&gt;&lt;munderover&gt;&lt;mo&gt;&amp;#x2211;&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/munderover&gt;&lt;munder&gt;&lt;mrow&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/msub&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;mo&gt;&amp;#x005F;&lt;/mo&gt;&lt;/munder&gt;&lt;mo&gt;&amp;#x22C5;&lt;/mo&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;g&lt;/mi&gt;&lt;mspace width=&quot;thickmathspace&quot; /&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/msub&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mo stretchy=&quot;false&quot;&gt;|&lt;/mo&gt;&lt;/mrow&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-435" style="width: 17.908em; display: inline-block;"><span style="display: inline-block; position: relative; width: 15.301em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(0.558em, 1015.22em, 3.592em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-436"><span class="msubsup" id="MathJax-Span-437"><span style="display: inline-block; position: relative; width: 1.156em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.64em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-438" style="font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.686em;"><span class="mi" id="MathJax-Span-439" style="font-size: 70.7%; font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-440" style="font-family: MathJax_Main; padding-left: 0.301em;">=</span><span class="mo" id="MathJax-Span-441" style="font-family: MathJax_Main; padding-left: 0.301em;">−</span><span class="mfrac" id="MathJax-Span-442"><span style="display: inline-block; position: relative; width: 0.729em; height: 0px; margin-right: 0.13em; margin-left: 0.13em;"><span style="position: absolute; clip: rect(3.207em, 1000.43em, 4.147em, -999.998em); top: -4.699em; left: 50%; margin-left: -0.254em;"><span class="mn" id="MathJax-Span-443" style="font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.464em, 1000.6em, 4.147em, -999.998em); top: -3.331em; left: 50%; margin-left: -0.297em;"><span class="mi" id="MathJax-Span-444" style="font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(0.9em, 1000.73em, 1.199em, -999.998em); top: -1.28em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.4px solid; width: 0.729em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.071em;"></span></span></span></span><span class="munderover" id="MathJax-Span-445" style="padding-left: 0.173em;"><span style="display: inline-block; position: relative; width: 1.455em; height: 0px;"><span style="position: absolute; clip: rect(2.951em, 1001.37em, 4.618em, -999.998em); top: -4.015em; left: 0em;"><span class="mo" id="MathJax-Span-446" style="font-family: MathJax_Size2; vertical-align: 0em;">∑</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.421em, 1001.11em, 4.276em, -999.998em); top: -2.947em; left: 0.13em;"><span class="texatom" id="MathJax-Span-447"><span class="mrow" id="MathJax-Span-448"><span class="mi" id="MathJax-Span-449" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span><span class="mo" id="MathJax-Span-450" style="font-size: 70.7%; font-family: MathJax_Main;">=</span><span class="mn" id="MathJax-Span-451" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -5.169em; left: 0.515em;"><span class="texatom" id="MathJax-Span-452"><span class="mrow" id="MathJax-Span-453"><span class="mi" id="MathJax-Span-454" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="munderover" id="MathJax-Span-455" style="padding-left: 0.173em;"><span style="display: inline-block; position: relative; width: 3.635em; height: 0px;"><span style="position: absolute; clip: rect(3.122em, 1003.51em, 4.404em, -999.998em); top: -4.015em; left: 0.002em;"><span class="mrow" id="MathJax-Span-456"><span class="mi" id="MathJax-Span-457" style="font-family: MathJax_Math-italic;">A</span><span class="mo" id="MathJax-Span-458" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-459"><span style="display: inline-block; position: relative; width: 0.771em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-460" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mi" id="MathJax-Span-461" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-462" style="font-family: MathJax_Main;">,</span><span class="msubsup" id="MathJax-Span-463" style="padding-left: 0.173em;"><span style="display: inline-block; position: relative; width: 0.857em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.51em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-464" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.515em;"><span class="mi" id="MathJax-Span-465" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-466" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.635em, 1003.63em, 3.934em, -999.998em); top: -3.331em; left: 0em;"><span class="mo" id="MathJax-Span-467" style=""><span style="display: inline-block; position: relative; width: 3.635em; height: 0px;"><span style="position: absolute; font-family: MathJax_Main; top: -4.015em; left: -0.083em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; font-family: MathJax_Main; top: -4.015em; left: 2.951em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 0.387em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 0.9em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 1.412em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 1.925em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 2.438em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-468" style="font-family: MathJax_Main; padding-left: 0.216em;">⋅</span><span class="mi" id="MathJax-Span-469" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">l</span><span class="mi" id="MathJax-Span-470" style="font-family: MathJax_Math-italic;">o</span><span class="mi" id="MathJax-Span-471" style="font-family: MathJax_Math-italic;">g<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mspace" id="MathJax-Span-472" style="height: 0em; vertical-align: 0em; width: 0.301em; display: inline-block; overflow: hidden;"></span><span class="mi" id="MathJax-Span-473" style="font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mo" id="MathJax-Span-474" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-475"><span style="display: inline-block; position: relative; width: 0.857em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.51em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-476" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.515em;"><span class="mi" id="MathJax-Span-477" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="texatom" id="MathJax-Span-478"><span class="mrow" id="MathJax-Span-479"><span class="mo" id="MathJax-Span-480" style="font-family: MathJax_Main;">|</span></span></span><span class="msubsup" id="MathJax-Span-481"><span style="display: inline-block; position: relative; width: 0.771em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-482" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mi" id="MathJax-Span-483" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-484" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -1.448em; border-left: 0px solid; width: 0px; height: 3.353em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mi>L</mi><mi>π</mi></msub><mo>=</mo><mo>−</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow class="MJX-TeXAtom-ORD"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class="MJX-TeXAtom-ORD"><mi>n</mi></mrow></munderover><munder><mrow><mi>A</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mi>i</mi></msub><mo>,</mo><msub><mi>a</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><mo>_</mo></munder><mo>⋅</mo><mi>l</mi><mi>o</mi><mi>g</mi><mspace width="thickmathspace"></mspace><mi>π</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mi>i</mi></msub><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><msub><mi>s</mi><mi>i</mi></msub><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-22">L_\pi = - \frac{1}{n} \sum_{i=1}^{n} \underline{A(s_i, a_i)} \cdot log\;\pi(a_i|s_i)</script>

<h4 id="value-loss">Value loss</h4>
<p>Learning the value function <em>V(s)</em> is analogous to Q-learning case, where we tried to learn action-value function <em>Q(s, a)</em>. In n-step return scenario, we know that the true function <em>V(s)</em> should meet the Bellman equation:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-23-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msup&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-485" style="width: 25.9em; display: inline-block;"><span style="display: inline-block; position: relative; width: 22.139em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.241em, 1022.05em, 2.652em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-486"><span class="mi" id="MathJax-Span-487" style="font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-488" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-489"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-490" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-491" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-492" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-493" style="font-family: MathJax_Main; padding-left: 0.301em;">=</span><span class="msubsup" id="MathJax-Span-494" style="padding-left: 0.301em;"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-495" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-496" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-497" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="mi" id="MathJax-Span-498" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span class="msubsup" id="MathJax-Span-499"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-500" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-501" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-502" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="msubsup" id="MathJax-Span-503" style="padding-left: 0.216em;"><span style="display: inline-block; position: relative; width: 1.028em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-504" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="mn" id="MathJax-Span-505" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-506"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-507" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-508" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-509" style="font-family: MathJax_Main;">+</span><span class="mo" id="MathJax-Span-510" style="font-family: MathJax_Main;">.</span><span class="mo" id="MathJax-Span-511" style="font-family: MathJax_Main; padding-left: 0.173em;">.</span><span class="mo" id="MathJax-Span-512" style="font-family: MathJax_Main; padding-left: 0.173em;">.</span><span class="mo" id="MathJax-Span-513" style="font-family: MathJax_Main; padding-left: 0.173em;">+</span><span class="msubsup" id="MathJax-Span-514"><span style="display: inline-block; position: relative; width: 2.011em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-515" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="texatom" id="MathJax-Span-516"><span class="mrow" id="MathJax-Span-517"><span class="mi" id="MathJax-Span-518" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span class="mo" id="MathJax-Span-519" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-520" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-521"><span style="display: inline-block; position: relative; width: 1.84em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-522" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="texatom" id="MathJax-Span-523"><span class="mrow" id="MathJax-Span-524"><span class="mi" id="MathJax-Span-525" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span class="mo" id="MathJax-Span-526" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-527" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-528" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="msubsup" id="MathJax-Span-529" style="padding-left: 0.216em;"><span style="display: inline-block; position: relative; width: 1.113em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-530" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="mi" id="MathJax-Span-531" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mi" id="MathJax-Span-532" style="font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-533" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-534"><span style="display: inline-block; position: relative; width: 0.985em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-535" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mi" id="MathJax-Span-536" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-537" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.453em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>V</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mn>0</mn></msub><mo stretchy="false">)</mo><mo>=</mo><msub><mi>r</mi><mn>0</mn></msub><mo>+</mo><mi>γ</mi><msub><mi>r</mi><mn>1</mn></msub><mo>+</mo><msup><mi>γ</mi><mn>2</mn></msup><msub><mi>r</mi><mn>2</mn></msub><mo>+</mo><mo>.</mo><mo>.</mo><mo>.</mo><mo>+</mo><msup><mi>γ</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msup><msub><mi>r</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>+</mo><msup><mi>γ</mi><mi>n</mi></msup><mi>V</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mi>n</mi></msub><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-23">V(s_0) = r_0 + \gamma r_1 + \gamma^2 r_2 + ... + \gamma^{n-1} r_{n-1} + \gamma^n V(s_n)</script>

<p>The approximated <em>V(s)</em> should converge according to this formula and we can measure the error as:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-24-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msup&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-538" style="width: 27.865em; display: inline-block;"><span style="display: inline-block; position: relative; width: 23.806em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.241em, 1023.72em, 2.652em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-539"><span class="mi" id="MathJax-Span-540" style="font-family: MathJax_Math-italic;">e</span><span class="mo" id="MathJax-Span-541" style="font-family: MathJax_Main; padding-left: 0.301em;">=</span><span class="msubsup" id="MathJax-Span-542" style="padding-left: 0.301em;"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-543" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-544" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-545" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="mi" id="MathJax-Span-546" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span class="msubsup" id="MathJax-Span-547"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-548" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-549" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-550" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="msubsup" id="MathJax-Span-551" style="padding-left: 0.216em;"><span style="display: inline-block; position: relative; width: 1.028em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-552" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="mn" id="MathJax-Span-553" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-554"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-555" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-556" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-557" style="font-family: MathJax_Main;">+</span><span class="mo" id="MathJax-Span-558" style="font-family: MathJax_Main;">.</span><span class="mo" id="MathJax-Span-559" style="font-family: MathJax_Main; padding-left: 0.173em;">.</span><span class="mo" id="MathJax-Span-560" style="font-family: MathJax_Main; padding-left: 0.173em;">.</span><span class="mo" id="MathJax-Span-561" style="font-family: MathJax_Main; padding-left: 0.173em;">+</span><span class="msubsup" id="MathJax-Span-562"><span style="display: inline-block; position: relative; width: 2.011em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-563" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="texatom" id="MathJax-Span-564"><span class="mrow" id="MathJax-Span-565"><span class="mi" id="MathJax-Span-566" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span class="mo" id="MathJax-Span-567" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-568" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-569"><span style="display: inline-block; position: relative; width: 1.84em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-570" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="texatom" id="MathJax-Span-571"><span class="mrow" id="MathJax-Span-572"><span class="mi" id="MathJax-Span-573" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span class="mo" id="MathJax-Span-574" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-575" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-576" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="msubsup" id="MathJax-Span-577" style="padding-left: 0.216em;"><span style="display: inline-block; position: relative; width: 1.113em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-578" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="mi" id="MathJax-Span-579" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mi" id="MathJax-Span-580" style="font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-581" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-582"><span style="display: inline-block; position: relative; width: 0.985em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-583" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mi" id="MathJax-Span-584" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-585" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-586" style="font-family: MathJax_Main; padding-left: 0.216em;">−</span><span class="mi" id="MathJax-Span-587" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-588" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-589"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-590" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-591" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-592" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.453em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>e</mi><mo>=</mo><msub><mi>r</mi><mn>0</mn></msub><mo>+</mo><mi>γ</mi><msub><mi>r</mi><mn>1</mn></msub><mo>+</mo><msup><mi>γ</mi><mn>2</mn></msup><msub><mi>r</mi><mn>2</mn></msub><mo>+</mo><mo>.</mo><mo>.</mo><mo>.</mo><mo>+</mo><msup><mi>γ</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msup><msub><mi>r</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>+</mo><msup><mi>γ</mi><mi>n</mi></msup><mi>V</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mi>n</mi></msub><mo stretchy="false">)</mo><mo>−</mo><mi>V</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mn>0</mn></msub><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-24">e = r_0 + \gamma r_1 + \gamma^2 r_2 + ... + \gamma^{n-1} r_{n-1} + \gamma^n V(s_n) - V(s_0)</script>

<p>Then we can define the <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-25-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-593" style="width: 1.498em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.284em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1001.28em, 2.481em, -999.998em); top: -2.177em; left: 0em;"><span class="mrow" id="MathJax-Span-594"><span class="msubsup" id="MathJax-Span-595"><span style="display: inline-block; position: relative; width: 1.284em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.64em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-596" style="font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.686em;"><span class="mi" id="MathJax-Span-597" style="font-size: 70.7%; font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.13em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.182em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.103em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>L</mi><mi>V</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-25">L_V</script> as a mean squared error of all given samples as:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-26-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;/msub&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mfrac&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mfrac&gt;&lt;munderover&gt;&lt;mo&gt;&amp;#x2211;&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/munderover&gt;&lt;msubsup&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msubsup&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-598" style="width: 7.481em; display: inline-block;"><span style="display: inline-block; position: relative; width: 6.37em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(0.558em, 1006.37em, 3.592em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-599"><span class="msubsup" id="MathJax-Span-600"><span style="display: inline-block; position: relative; width: 1.284em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.64em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-601" style="font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.686em;"><span class="mi" id="MathJax-Span-602" style="font-size: 70.7%; font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.13em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-603" style="font-family: MathJax_Main; padding-left: 0.301em;">=</span><span class="mfrac" id="MathJax-Span-604" style="padding-left: 0.301em;"><span style="display: inline-block; position: relative; width: 0.729em; height: 0px; margin-right: 0.13em; margin-left: 0.13em;"><span style="position: absolute; clip: rect(3.207em, 1000.43em, 4.147em, -999.998em); top: -4.699em; left: 50%; margin-left: -0.254em;"><span class="mn" id="MathJax-Span-605" style="font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.464em, 1000.6em, 4.147em, -999.998em); top: -3.331em; left: 50%; margin-left: -0.297em;"><span class="mi" id="MathJax-Span-606" style="font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(0.9em, 1000.73em, 1.199em, -999.998em); top: -1.28em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.4px solid; width: 0.729em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.071em;"></span></span></span></span><span class="munderover" id="MathJax-Span-607" style="padding-left: 0.173em;"><span style="display: inline-block; position: relative; width: 1.455em; height: 0px;"><span style="position: absolute; clip: rect(2.951em, 1001.37em, 4.618em, -999.998em); top: -4.015em; left: 0em;"><span class="mo" id="MathJax-Span-608" style="font-family: MathJax_Size2; vertical-align: 0em;">∑</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.421em, 1001.11em, 4.276em, -999.998em); top: -2.947em; left: 0.13em;"><span class="texatom" id="MathJax-Span-609"><span class="mrow" id="MathJax-Span-610"><span class="mi" id="MathJax-Span-611" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span><span class="mo" id="MathJax-Span-612" style="font-size: 70.7%; font-family: MathJax_Main;">=</span><span class="mn" id="MathJax-Span-613" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -5.169em; left: 0.515em;"><span class="texatom" id="MathJax-Span-614"><span class="mrow" id="MathJax-Span-615"><span class="mi" id="MathJax-Span-616" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-617" style="padding-left: 0.173em;"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-618" style="font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.421em, 1000.43em, 4.147em, -999.998em); top: -4.357em; left: 0.472em;"><span class="mn" id="MathJax-Span-619" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.421em, 1000.3em, 4.147em, -999.998em); top: -3.716em; left: 0.472em;"><span class="mi" id="MathJax-Span-620" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -1.448em; border-left: 0px solid; width: 0px; height: 3.353em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mi>L</mi><mi>V</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow class="MJX-TeXAtom-ORD"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class="MJX-TeXAtom-ORD"><mi>n</mi></mrow></munderover><msubsup><mi>e</mi><mi>i</mi><mn>2</mn></msubsup></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-26">L_V = \frac{1}{n}\sum_{i=1}^{n} e_i^2</script>

<h4 id="regularization-with-policy-entropy">Regularization with policy entropy</h4>
<p>Adding entropy to the loss function was found to improve exploration by limiting the premature convergence to suboptimal policy<sup id="fnref:1"><a href="https://jaromiru.com/2017/03/26/lets-make-an-a3c-implementation/#fn:1" class="footnote">2</a></sup>. Entropy for policy <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-27-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-621" style="width: 2.096em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.797em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1001.71em, 2.652em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-622"><span class="mi" id="MathJax-Span-623" style="font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mo" id="MathJax-Span-624" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-625" style="font-family: MathJax_Math-italic;">s</span><span class="mo" id="MathJax-Span-626" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.252em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>π</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-27">\pi(s)</script> is defined as:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-28-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mi&gt;H&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;munderover&gt;&lt;mo&gt;&amp;#x2211;&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;k&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/munderover&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mi&gt;k&lt;/mi&gt;&lt;/msub&gt;&lt;mo&gt;&amp;#x22C5;&lt;/mo&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;g&lt;/mi&gt;&lt;mspace width=&quot;thickmathspace&quot; /&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mi&gt;k&lt;/mi&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-627" style="width: 16.626em; display: inline-block;"><span style="display: inline-block; position: relative; width: 14.19em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(0.558em, 1014.19em, 3.592em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-628"><span class="mi" id="MathJax-Span-629" style="font-family: MathJax_Math-italic;">H<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span class="mo" id="MathJax-Span-630" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-631" style="font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mo" id="MathJax-Span-632" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-633" style="font-family: MathJax_Math-italic;">s</span><span class="mo" id="MathJax-Span-634" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-635" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-636" style="font-family: MathJax_Main; padding-left: 0.301em;">=</span><span class="mo" id="MathJax-Span-637" style="font-family: MathJax_Main; padding-left: 0.301em;">−</span><span class="munderover" id="MathJax-Span-638" style="padding-left: 0.173em;"><span style="display: inline-block; position: relative; width: 1.455em; height: 0px;"><span style="position: absolute; clip: rect(2.951em, 1001.37em, 4.618em, -999.998em); top: -4.015em; left: 0em;"><span class="mo" id="MathJax-Span-639" style="font-family: MathJax_Size2; vertical-align: 0em;">∑</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.421em, 1001.24em, 4.276em, -999.998em); top: -2.904em; left: 0.088em;"><span class="texatom" id="MathJax-Span-640"><span class="mrow" id="MathJax-Span-641"><span class="mi" id="MathJax-Span-642" style="font-size: 70.7%; font-family: MathJax_Math-italic;">k</span><span class="mo" id="MathJax-Span-643" style="font-size: 70.7%; font-family: MathJax_Main;">=</span><span class="mn" id="MathJax-Span-644" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -5.169em; left: 0.515em;"><span class="texatom" id="MathJax-Span-645"><span class="mrow" id="MathJax-Span-646"><span class="mi" id="MathJax-Span-647" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mi" id="MathJax-Span-648" style="font-family: MathJax_Math-italic; padding-left: 0.173em;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mo" id="MathJax-Span-649" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-650" style="font-family: MathJax_Math-italic;">s</span><span class="msubsup" id="MathJax-Span-651"><span style="display: inline-block; position: relative; width: 0.814em; height: 0px;"><span style="position: absolute; clip: rect(3.122em, 1000.3em, 4.404em, -999.998em); top: -4.015em; left: 0em;"><span class="mo" id="MathJax-Span-652" style="font-family: MathJax_Main;">)</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.387em;"><span class="mi" id="MathJax-Span-653" style="font-size: 70.7%; font-family: MathJax_Math-italic;">k</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-654" style="font-family: MathJax_Main; padding-left: 0.216em;">⋅</span><span class="mi" id="MathJax-Span-655" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">l</span><span class="mi" id="MathJax-Span-656" style="font-family: MathJax_Math-italic;">o</span><span class="mi" id="MathJax-Span-657" style="font-family: MathJax_Math-italic;">g<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mspace" id="MathJax-Span-658" style="height: 0em; vertical-align: 0em; width: 0.301em; display: inline-block; overflow: hidden;"></span><span class="mi" id="MathJax-Span-659" style="font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mo" id="MathJax-Span-660" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-661" style="font-family: MathJax_Math-italic;">s</span><span class="msubsup" id="MathJax-Span-662"><span style="display: inline-block; position: relative; width: 0.814em; height: 0px;"><span style="position: absolute; clip: rect(3.122em, 1000.3em, 4.404em, -999.998em); top: -4.015em; left: 0em;"><span class="mo" id="MathJax-Span-663" style="font-family: MathJax_Main;">)</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.387em;"><span class="mi" id="MathJax-Span-664" style="font-size: 70.7%; font-family: MathJax_Math-italic;">k</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -1.448em; border-left: 0px solid; width: 0px; height: 3.353em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>H</mi><mo stretchy="false">(</mo><mi>π</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><munderover><mo>∑</mo><mrow class="MJX-TeXAtom-ORD"><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mrow class="MJX-TeXAtom-ORD"><mi>n</mi></mrow></munderover><mi>π</mi><mo stretchy="false">(</mo><mi>s</mi><msub><mo stretchy="false">)</mo><mi>k</mi></msub><mo>⋅</mo><mi>l</mi><mi>o</mi><mi>g</mi><mspace width="thickmathspace"></mspace><mi>π</mi><mo stretchy="false">(</mo><mi>s</mi><msub><mo stretchy="false">)</mo><mi>k</mi></msub></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-28">H(\pi(s)) = - \sum_{k=1}^{n} \pi(s)_k \cdot log\;\pi(s)_k</script>

<p>Where <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-29-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mi&gt;k&lt;/mi&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-665" style="width: 2.652em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.267em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1002.27em, 2.652em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-666"><span class="mi" id="MathJax-Span-667" style="font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mo" id="MathJax-Span-668" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-669" style="font-family: MathJax_Math-italic;">s</span><span class="msubsup" id="MathJax-Span-670"><span style="display: inline-block; position: relative; width: 0.814em; height: 0px;"><span style="position: absolute; clip: rect(3.122em, 1000.3em, 4.404em, -999.998em); top: -4.015em; left: 0em;"><span class="mo" id="MathJax-Span-671" style="font-family: MathJax_Main;">)</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.387em;"><span class="mi" id="MathJax-Span-672" style="font-size: 70.7%; font-family: MathJax_Math-italic;">k</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.252em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>π</mi><mo stretchy="false">(</mo><mi>s</mi><msub><mo stretchy="false">)</mo><mi>k</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-29">\pi(s)_k</script> is a probability for <em>k</em>-th action in state <em>s</em>. It’s useful to know that entropy for fully deterministic policy (e.g. <code class="language-plaintext highlighter-rouge">[1, 0, 0, 0]</code> for four actions) is 0 and it is maximized for totally uniform policy (e.g. <code class="language-plaintext highlighter-rouge">[0.25, 0.25, 0.25, 0.25]</code>).</p>

<p>Knowing this we see that by trying to maximize the entropy, we are keeping the policy away from the deterministic one. This fact stimulate exploration.</p>

<p>Averaging over all samples in a batch, <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-30-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;g&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-673" style="width: 2.053em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.754em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1001.75em, 2.609em, -999.998em); top: -2.177em; left: 0em;"><span class="mrow" id="MathJax-Span-674"><span class="msubsup" id="MathJax-Span-675"><span style="display: inline-block; position: relative; width: 1.754em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.64em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-676" style="font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.686em;"><span class="texatom" id="MathJax-Span-677"><span class="mrow" id="MathJax-Span-678"><span class="mi" id="MathJax-Span-679" style="font-size: 70.7%; font-family: MathJax_Math-italic;">r</span><span class="mi" id="MathJax-Span-680" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span class="mi" id="MathJax-Span-681" style="font-size: 70.7%; font-family: MathJax_Math-italic;">g<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.182em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.398em; border-left: 0px solid; width: 0px; height: 1.252em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>L</mi><mrow class="MJX-TeXAtom-ORD"><mi>r</mi><mi>e</mi><mi>g</mi></mrow></msub></math></span></span><script type="math/tex" id="MathJax-Element-30">L_{reg}</script> is then set to:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-31-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;g&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mfrac&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mfrac&gt;&lt;munderover&gt;&lt;mo&gt;&amp;#x2211;&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/munderover&gt;&lt;mi&gt;H&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-682" style="width: 12.267em; display: inline-block;"><span style="display: inline-block; position: relative; width: 10.472em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(0.558em, 1010.39em, 3.592em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-683"><span class="msubsup" id="MathJax-Span-684"><span style="display: inline-block; position: relative; width: 1.754em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.64em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-685" style="font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.686em;"><span class="texatom" id="MathJax-Span-686"><span class="mrow" id="MathJax-Span-687"><span class="mi" id="MathJax-Span-688" style="font-size: 70.7%; font-family: MathJax_Math-italic;">r</span><span class="mi" id="MathJax-Span-689" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span class="mi" id="MathJax-Span-690" style="font-size: 70.7%; font-family: MathJax_Math-italic;">g<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-691" style="font-family: MathJax_Main; padding-left: 0.301em;">=</span><span class="mo" id="MathJax-Span-692" style="font-family: MathJax_Main; padding-left: 0.301em;">−</span><span class="mfrac" id="MathJax-Span-693"><span style="display: inline-block; position: relative; width: 0.729em; height: 0px; margin-right: 0.13em; margin-left: 0.13em;"><span style="position: absolute; clip: rect(3.207em, 1000.43em, 4.147em, -999.998em); top: -4.699em; left: 50%; margin-left: -0.254em;"><span class="mn" id="MathJax-Span-694" style="font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.464em, 1000.6em, 4.147em, -999.998em); top: -3.331em; left: 50%; margin-left: -0.297em;"><span class="mi" id="MathJax-Span-695" style="font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(0.9em, 1000.73em, 1.199em, -999.998em); top: -1.28em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.4px solid; width: 0.729em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.071em;"></span></span></span></span><span class="munderover" id="MathJax-Span-696" style="padding-left: 0.173em;"><span style="display: inline-block; position: relative; width: 1.455em; height: 0px;"><span style="position: absolute; clip: rect(2.951em, 1001.37em, 4.618em, -999.998em); top: -4.015em; left: 0em;"><span class="mo" id="MathJax-Span-697" style="font-family: MathJax_Size2; vertical-align: 0em;">∑</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.421em, 1001.11em, 4.276em, -999.998em); top: -2.947em; left: 0.13em;"><span class="texatom" id="MathJax-Span-698"><span class="mrow" id="MathJax-Span-699"><span class="mi" id="MathJax-Span-700" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span><span class="mo" id="MathJax-Span-701" style="font-size: 70.7%; font-family: MathJax_Main;">=</span><span class="mn" id="MathJax-Span-702" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -5.169em; left: 0.515em;"><span class="texatom" id="MathJax-Span-703"><span class="mrow" id="MathJax-Span-704"><span class="mi" id="MathJax-Span-705" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mi" id="MathJax-Span-706" style="font-family: MathJax_Math-italic; padding-left: 0.173em;">H<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span class="mo" id="MathJax-Span-707" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-708" style="font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mo" id="MathJax-Span-709" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-710"><span style="display: inline-block; position: relative; width: 0.771em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-711" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mi" id="MathJax-Span-712" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-713" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-714" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -1.448em; border-left: 0px solid; width: 0px; height: 3.353em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mi>L</mi><mrow class="MJX-TeXAtom-ORD"><mi>r</mi><mi>e</mi><mi>g</mi></mrow></msub><mo>=</mo><mo>−</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow class="MJX-TeXAtom-ORD"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class="MJX-TeXAtom-ORD"><mi>n</mi></mrow></munderover><mi>H</mi><mo stretchy="false">(</mo><mi>π</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-31">L_{reg} = - \frac{1}{n}\sum_{i=1}^{n} H(\pi(s_i))</script>

<h4 id="tensorflow-graph">TensorFlow graph</h4>
<p>So, how do we actually implement all of the above? We need to define a TensorFlow graph of the loss function that allows it’s analytical computation.</p>

<p>First we need placeholders, that will be filled with relevant data when a <em>minimize</em> operation is run. They represent a 2D array and will hold a whole batch. The first dimension represent different samples in a batch and is unlimited. The second dimension is different for each placeholder, representing a dimension of state, one-hot encoded action and reward.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1"># starting states
</span>        <span class="n">s_t</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">NUM_STATE</span><span class="p">))</span>

        <span class="c1"># one hot encoded actions
</span>        <span class="n">a_t</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">NUM_ACTIONS</span><span class="p">))</span>

        <span class="c1"># n-step discounted total reward 
</span>        <span class="n">r_t</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</code></pre></div></div>

<p>Then we propagate the states through our network to get policy and value outputs. Note that we are actually not running any operation at this time, but rather defining a graph that will be run during the <em>minimize</em> operation.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">p</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">s_t</span><span class="p">)</span>
</code></pre></div></div>

<p>Now let’s recall how does the <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-32-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-715" style="width: 1.37em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.156em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1001.16em, 2.481em, -999.998em); top: -2.177em; left: 0em;"><span class="mrow" id="MathJax-Span-716"><span class="msubsup" id="MathJax-Span-717"><span style="display: inline-block; position: relative; width: 1.156em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.64em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-718" style="font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.686em;"><span class="mi" id="MathJax-Span-719" style="font-size: 70.7%; font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.182em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.103em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>L</mi><mi>π</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-32">L_\pi</script> part of our loss function look like:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-33-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;/msub&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mfrac&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mfrac&gt;&lt;munderover&gt;&lt;mo&gt;&amp;#x2211;&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/munderover&gt;&lt;munder&gt;&lt;mrow&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/msub&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;mo&gt;&amp;#x005F;&lt;/mo&gt;&lt;/munder&gt;&lt;mo&gt;&amp;#x22C5;&lt;/mo&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;g&lt;/mi&gt;&lt;mspace width=&quot;thickmathspace&quot; /&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/msub&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mo stretchy=&quot;false&quot;&gt;|&lt;/mo&gt;&lt;/mrow&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-720" style="width: 17.908em; display: inline-block;"><span style="display: inline-block; position: relative; width: 15.301em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(0.558em, 1015.22em, 3.592em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-721"><span class="msubsup" id="MathJax-Span-722"><span style="display: inline-block; position: relative; width: 1.156em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.64em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-723" style="font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.686em;"><span class="mi" id="MathJax-Span-724" style="font-size: 70.7%; font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-725" style="font-family: MathJax_Main; padding-left: 0.301em;">=</span><span class="mo" id="MathJax-Span-726" style="font-family: MathJax_Main; padding-left: 0.301em;">−</span><span class="mfrac" id="MathJax-Span-727"><span style="display: inline-block; position: relative; width: 0.729em; height: 0px; margin-right: 0.13em; margin-left: 0.13em;"><span style="position: absolute; clip: rect(3.207em, 1000.43em, 4.147em, -999.998em); top: -4.699em; left: 50%; margin-left: -0.254em;"><span class="mn" id="MathJax-Span-728" style="font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.464em, 1000.6em, 4.147em, -999.998em); top: -3.331em; left: 50%; margin-left: -0.297em;"><span class="mi" id="MathJax-Span-729" style="font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(0.9em, 1000.73em, 1.199em, -999.998em); top: -1.28em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.4px solid; width: 0.729em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.071em;"></span></span></span></span><span class="munderover" id="MathJax-Span-730" style="padding-left: 0.173em;"><span style="display: inline-block; position: relative; width: 1.455em; height: 0px;"><span style="position: absolute; clip: rect(2.951em, 1001.37em, 4.618em, -999.998em); top: -4.015em; left: 0em;"><span class="mo" id="MathJax-Span-731" style="font-family: MathJax_Size2; vertical-align: 0em;">∑</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.421em, 1001.11em, 4.276em, -999.998em); top: -2.947em; left: 0.13em;"><span class="texatom" id="MathJax-Span-732"><span class="mrow" id="MathJax-Span-733"><span class="mi" id="MathJax-Span-734" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span><span class="mo" id="MathJax-Span-735" style="font-size: 70.7%; font-family: MathJax_Main;">=</span><span class="mn" id="MathJax-Span-736" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -5.169em; left: 0.515em;"><span class="texatom" id="MathJax-Span-737"><span class="mrow" id="MathJax-Span-738"><span class="mi" id="MathJax-Span-739" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="munderover" id="MathJax-Span-740" style="padding-left: 0.173em;"><span style="display: inline-block; position: relative; width: 3.635em; height: 0px;"><span style="position: absolute; clip: rect(3.122em, 1003.51em, 4.404em, -999.998em); top: -4.015em; left: 0.002em;"><span class="mrow" id="MathJax-Span-741"><span class="mi" id="MathJax-Span-742" style="font-family: MathJax_Math-italic;">A</span><span class="mo" id="MathJax-Span-743" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-744"><span style="display: inline-block; position: relative; width: 0.771em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-745" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mi" id="MathJax-Span-746" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-747" style="font-family: MathJax_Main;">,</span><span class="msubsup" id="MathJax-Span-748" style="padding-left: 0.173em;"><span style="display: inline-block; position: relative; width: 0.857em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.51em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-749" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.515em;"><span class="mi" id="MathJax-Span-750" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-751" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.635em, 1003.63em, 3.934em, -999.998em); top: -3.331em; left: 0em;"><span class="mo" id="MathJax-Span-752" style=""><span style="display: inline-block; position: relative; width: 3.635em; height: 0px;"><span style="position: absolute; font-family: MathJax_Main; top: -4.015em; left: -0.083em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; font-family: MathJax_Main; top: -4.015em; left: 2.951em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 0.387em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 0.9em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 1.412em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 1.925em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 2.438em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-753" style="font-family: MathJax_Main; padding-left: 0.216em;">⋅</span><span class="mi" id="MathJax-Span-754" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">l</span><span class="mi" id="MathJax-Span-755" style="font-family: MathJax_Math-italic;">o</span><span class="mi" id="MathJax-Span-756" style="font-family: MathJax_Math-italic;">g<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mspace" id="MathJax-Span-757" style="height: 0em; vertical-align: 0em; width: 0.301em; display: inline-block; overflow: hidden;"></span><span class="mi" id="MathJax-Span-758" style="font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mo" id="MathJax-Span-759" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-760"><span style="display: inline-block; position: relative; width: 0.857em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.51em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-761" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.515em;"><span class="mi" id="MathJax-Span-762" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="texatom" id="MathJax-Span-763"><span class="mrow" id="MathJax-Span-764"><span class="mo" id="MathJax-Span-765" style="font-family: MathJax_Main;">|</span></span></span><span class="msubsup" id="MathJax-Span-766"><span style="display: inline-block; position: relative; width: 0.771em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-767" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mi" id="MathJax-Span-768" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-769" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -1.448em; border-left: 0px solid; width: 0px; height: 3.353em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mi>L</mi><mi>π</mi></msub><mo>=</mo><mo>−</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow class="MJX-TeXAtom-ORD"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class="MJX-TeXAtom-ORD"><mi>n</mi></mrow></munderover><munder><mrow><mi>A</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mi>i</mi></msub><mo>,</mo><msub><mi>a</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><mo>_</mo></munder><mo>⋅</mo><mi>l</mi><mi>o</mi><mi>g</mi><mspace width="thickmathspace"></mspace><mi>π</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mi>i</mi></msub><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><msub><mi>s</mi><mi>i</mi></msub><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-33">L_\pi = - \frac{1}{n} \sum_{i=1}^{n} \underline{A(s_i, a_i)} \cdot log\;\pi(a_i|s_i)</script>

<p>The expression <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-34-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;g&lt;/mi&gt;&lt;mspace width=&quot;thickmathspace&quot; /&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mo fence=&quot;false&quot; stretchy=&quot;false&quot;&gt;&amp;#x2016;&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-770" style="width: 5.173em; display: inline-block;"><span style="display: inline-block; position: relative; width: 4.404em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1004.32em, 2.652em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-771"><span class="mi" id="MathJax-Span-772" style="font-family: MathJax_Math-italic;">l</span><span class="mi" id="MathJax-Span-773" style="font-family: MathJax_Math-italic;">o</span><span class="mi" id="MathJax-Span-774" style="font-family: MathJax_Math-italic;">g<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mspace" id="MathJax-Span-775" style="height: 0em; vertical-align: 0em; width: 0.301em; display: inline-block; overflow: hidden;"></span><span class="mi" id="MathJax-Span-776" style="font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mo" id="MathJax-Span-777" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-778" style="font-family: MathJax_Math-italic;">a</span><span class="mo" id="MathJax-Span-779" style="font-family: MathJax_Main;">∥</span><span class="mi" id="MathJax-Span-780" style="font-family: MathJax_Math-italic;">s</span><span class="mo" id="MathJax-Span-781" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.252em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>l</mi><mi>o</mi><mi>g</mi><mspace width="thickmathspace"></mspace><mi>π</mi><mo stretchy="false">(</mo><mi>a</mi><mo fence="false" stretchy="false">‖</mo><mi>s</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-34">log\;\pi(a\|s)</script> means a probability of taking action <em>a</em> in state <em>s</em>, or in other words, the <em>a</em>-th index of <em>π(s)</em>. Unfortunately, we can’t use indexes when defining TensorFlow graph, but we can use other arithmetic operations. If we take the whole policy, multiply it with one-hot encoded action and sum these together, we get exactly what we need.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">logp</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">a_t</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keep_dims</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
</code></pre></div></div>

<p>We add a small constant to prevent a <code class="language-plaintext highlighter-rouge">NaN</code> error that could occur if we selected an action while it’s probability was zero. That could happen, because we are using ε-greedy policy.</p>

<p>We also need to be careful to do desired operations along correct dimensions, yielding desired outputs. TensorFlow is very silent about formal errors and an incorrect reduce operation can happen very easily. Always debug your code when you play with graph implementation and make sure to print out tensor dimensions for each operation.</p>

<p>The other half of the equation is the advantage function. We use a fact that the <code class="language-plaintext highlighter-rouge">r_t</code> placeholder holds a value of:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-35-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;&amp;#x005F;&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msup&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-782" style="width: 24.575em; display: inline-block;"><span style="display: inline-block; position: relative; width: 20.985em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.241em, 1020.9em, 2.652em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-783"><span class="mi" id="MathJax-Span-784" style="font-family: MathJax_Math-italic;">r</span><span class="mi" id="MathJax-Span-785" style="font-family: MathJax_Main;">_</span><span class="mi" id="MathJax-Span-786" style="font-family: MathJax_Math-italic;">t</span><span class="mo" id="MathJax-Span-787" style="font-family: MathJax_Main; padding-left: 0.301em;">=</span><span class="msubsup" id="MathJax-Span-788" style="padding-left: 0.301em;"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-789" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-790" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-791" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="mi" id="MathJax-Span-792" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span class="msubsup" id="MathJax-Span-793"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-794" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-795" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-796" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="msubsup" id="MathJax-Span-797" style="padding-left: 0.216em;"><span style="display: inline-block; position: relative; width: 1.028em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-798" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="mn" id="MathJax-Span-799" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-800"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-801" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-802" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-803" style="font-family: MathJax_Main;">+</span><span class="mo" id="MathJax-Span-804" style="font-family: MathJax_Main;">.</span><span class="mo" id="MathJax-Span-805" style="font-family: MathJax_Main; padding-left: 0.173em;">.</span><span class="mo" id="MathJax-Span-806" style="font-family: MathJax_Main; padding-left: 0.173em;">.</span><span class="mo" id="MathJax-Span-807" style="font-family: MathJax_Main; padding-left: 0.173em;">+</span><span class="msubsup" id="MathJax-Span-808"><span style="display: inline-block; position: relative; width: 2.011em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-809" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="texatom" id="MathJax-Span-810"><span class="mrow" id="MathJax-Span-811"><span class="mi" id="MathJax-Span-812" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span class="mo" id="MathJax-Span-813" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-814" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-815"><span style="display: inline-block; position: relative; width: 1.84em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-816" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="texatom" id="MathJax-Span-817"><span class="mrow" id="MathJax-Span-818"><span class="mi" id="MathJax-Span-819" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span class="mo" id="MathJax-Span-820" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-821" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-822" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="msubsup" id="MathJax-Span-823" style="padding-left: 0.216em;"><span style="display: inline-block; position: relative; width: 1.113em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-824" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="mi" id="MathJax-Span-825" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mi" id="MathJax-Span-826" style="font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-827" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-828"><span style="display: inline-block; position: relative; width: 0.985em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-829" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mi" id="MathJax-Span-830" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-831" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.453em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>r</mi><mi mathvariant="normal">_</mi><mi>t</mi><mo>=</mo><msub><mi>r</mi><mn>0</mn></msub><mo>+</mo><mi>γ</mi><msub><mi>r</mi><mn>1</mn></msub><mo>+</mo><msup><mi>γ</mi><mn>2</mn></msup><msub><mi>r</mi><mn>2</mn></msub><mo>+</mo><mo>.</mo><mo>.</mo><mo>.</mo><mo>+</mo><msup><mi>γ</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msup><msub><mi>r</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>+</mo><msup><mi>γ</mi><mi>n</mi></msup><mi>V</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mi>n</mi></msub><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-35">r\_t = r_0 + \gamma r_1 + \gamma^2 r_2 + ... + \gamma^{n-1} r_{n-1} + \gamma^n V(s_n)</script>

<p>Recall that the n-step advantage function is defined as:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-36-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mi&gt;Q&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-832" style="width: 12.395em; display: inline-block;"><span style="display: inline-block; position: relative; width: 10.6em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1010.51em, 2.652em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-833"><span class="mi" id="MathJax-Span-834" style="font-family: MathJax_Math-italic;">A</span><span class="mo" id="MathJax-Span-835" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-836" style="font-family: MathJax_Math-italic;">s</span><span class="mo" id="MathJax-Span-837" style="font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-838" style="font-family: MathJax_Math-italic; padding-left: 0.173em;">a</span><span class="mo" id="MathJax-Span-839" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-840" style="font-family: MathJax_Main; padding-left: 0.301em;">=</span><span class="mi" id="MathJax-Span-841" style="font-family: MathJax_Math-italic; padding-left: 0.301em;">Q</span><span class="mo" id="MathJax-Span-842" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-843" style="font-family: MathJax_Math-italic;">s</span><span class="mo" id="MathJax-Span-844" style="font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-845" style="font-family: MathJax_Math-italic; padding-left: 0.173em;">a</span><span class="mo" id="MathJax-Span-846" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-847" style="font-family: MathJax_Main; padding-left: 0.216em;">−</span><span class="mi" id="MathJax-Span-848" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-849" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-850" style="font-family: MathJax_Math-italic;">s</span><span class="mo" id="MathJax-Span-851" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.252em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>A</mi><mo stretchy="false">(</mo><mi>s</mi><mo>,</mo><mi>a</mi><mo stretchy="false">)</mo><mo>=</mo><mi>Q</mi><mo stretchy="false">(</mo><mi>s</mi><mo>,</mo><mi>a</mi><mo stretchy="false">)</mo><mo>−</mo><mi>V</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-36">A(s, a) = Q(s, a) - V(s)</script>

<p>We can approximate the <em>Q(s, a)</em> function with samples we observed during an episode, resulting in:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-37-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msup&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-852" style="width: 30.301em; display: inline-block;"><span style="display: inline-block; position: relative; width: 25.9em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.241em, 1025.81em, 2.652em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-853"><span class="mi" id="MathJax-Span-854" style="font-family: MathJax_Math-italic;">A</span><span class="mo" id="MathJax-Span-855" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-856" style="font-family: MathJax_Math-italic;">s</span><span class="mo" id="MathJax-Span-857" style="font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-858" style="font-family: MathJax_Math-italic; padding-left: 0.173em;">a</span><span class="mo" id="MathJax-Span-859" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-860" style="font-family: MathJax_Main; padding-left: 0.301em;">=</span><span class="msubsup" id="MathJax-Span-861" style="padding-left: 0.301em;"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-862" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-863" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-864" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="mi" id="MathJax-Span-865" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span class="msubsup" id="MathJax-Span-866"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-867" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-868" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-869" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="msubsup" id="MathJax-Span-870" style="padding-left: 0.216em;"><span style="display: inline-block; position: relative; width: 1.028em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-871" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="mn" id="MathJax-Span-872" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-873"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-874" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-875" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-876" style="font-family: MathJax_Main;">+</span><span class="mo" id="MathJax-Span-877" style="font-family: MathJax_Main;">.</span><span class="mo" id="MathJax-Span-878" style="font-family: MathJax_Main; padding-left: 0.173em;">.</span><span class="mo" id="MathJax-Span-879" style="font-family: MathJax_Main; padding-left: 0.173em;">.</span><span class="mo" id="MathJax-Span-880" style="font-family: MathJax_Main; padding-left: 0.173em;">+</span><span class="msubsup" id="MathJax-Span-881"><span style="display: inline-block; position: relative; width: 2.011em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-882" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="texatom" id="MathJax-Span-883"><span class="mrow" id="MathJax-Span-884"><span class="mi" id="MathJax-Span-885" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span class="mo" id="MathJax-Span-886" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-887" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-888"><span style="display: inline-block; position: relative; width: 1.84em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-889" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="texatom" id="MathJax-Span-890"><span class="mrow" id="MathJax-Span-891"><span class="mi" id="MathJax-Span-892" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span class="mo" id="MathJax-Span-893" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-894" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-895" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="msubsup" id="MathJax-Span-896" style="padding-left: 0.216em;"><span style="display: inline-block; position: relative; width: 1.113em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-897" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="mi" id="MathJax-Span-898" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mi" id="MathJax-Span-899" style="font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-900" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-901"><span style="display: inline-block; position: relative; width: 0.985em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-902" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mi" id="MathJax-Span-903" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-904" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-905" style="font-family: MathJax_Main; padding-left: 0.216em;">−</span><span class="mi" id="MathJax-Span-906" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-907" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-908" style="font-family: MathJax_Math-italic;">s</span><span class="mo" id="MathJax-Span-909" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.453em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>A</mi><mo stretchy="false">(</mo><mi>s</mi><mo>,</mo><mi>a</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>r</mi><mn>0</mn></msub><mo>+</mo><mi>γ</mi><msub><mi>r</mi><mn>1</mn></msub><mo>+</mo><msup><mi>γ</mi><mn>2</mn></msup><msub><mi>r</mi><mn>2</mn></msub><mo>+</mo><mo>.</mo><mo>.</mo><mo>.</mo><mo>+</mo><msup><mi>γ</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msup><msub><mi>r</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>+</mo><msup><mi>γ</mi><mi>n</mi></msup><mi>V</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mi>n</mi></msub><mo stretchy="false">)</mo><mo>−</mo><mi>V</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-37">A(s, a) = r_0 + \gamma r_1 + \gamma^2 r_2 + ... + \gamma^{n-1} r_{n-1} + \gamma^n V(s_n) - V(s)</script>

<p>Defining the advantage function is therefore as simple as:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">advantage</span> <span class="o">=</span> <span class="n">r_t</span> <span class="o">-</span> <span class="n">v</span>
</code></pre></div></div>

<p>And finally, we can define the <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-38-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-910" style="width: 1.37em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.156em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1001.16em, 2.481em, -999.998em); top: -2.177em; left: 0em;"><span class="mrow" id="MathJax-Span-911"><span class="msubsup" id="MathJax-Span-912"><span style="display: inline-block; position: relative; width: 1.156em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.64em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-913" style="font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.686em;"><span class="mi" id="MathJax-Span-914" style="font-size: 70.7%; font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.182em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.103em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>L</mi><mi>π</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-38">L_\pi</script> itself. We need to take care to treat the advantage function as constant, by using <code class="language-plaintext highlighter-rouge">tf.stop_gradient()</code> operator. Expressions for <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-39-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-915" style="width: 1.37em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.156em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1001.16em, 2.481em, -999.998em); top: -2.177em; left: 0em;"><span class="mrow" id="MathJax-Span-916"><span class="msubsup" id="MathJax-Span-917"><span style="display: inline-block; position: relative; width: 1.156em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.64em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-918" style="font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.686em;"><span class="mi" id="MathJax-Span-919" style="font-size: 70.7%; font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.182em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.103em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>L</mi><mi>π</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-39">L_\pi</script>, <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-40-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-920" style="width: 1.498em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.284em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1001.28em, 2.481em, -999.998em); top: -2.177em; left: 0em;"><span class="mrow" id="MathJax-Span-921"><span class="msubsup" id="MathJax-Span-922"><span style="display: inline-block; position: relative; width: 1.284em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.64em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-923" style="font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.686em;"><span class="mi" id="MathJax-Span-924" style="font-size: 70.7%; font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.13em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.182em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.103em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>L</mi><mi>V</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-40">L_V</script> and <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-41-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;g&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-925" style="width: 2.053em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.754em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1001.75em, 2.609em, -999.998em); top: -2.177em; left: 0em;"><span class="mrow" id="MathJax-Span-926"><span class="msubsup" id="MathJax-Span-927"><span style="display: inline-block; position: relative; width: 1.754em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.64em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-928" style="font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.686em;"><span class="texatom" id="MathJax-Span-929"><span class="mrow" id="MathJax-Span-930"><span class="mi" id="MathJax-Span-931" style="font-size: 70.7%; font-family: MathJax_Math-italic;">r</span><span class="mi" id="MathJax-Span-932" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span class="mi" id="MathJax-Span-933" style="font-size: 70.7%; font-family: MathJax_Math-italic;">g<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.182em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.398em; border-left: 0px solid; width: 0px; height: 1.252em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>L</mi><mrow class="MJX-TeXAtom-ORD"><mi>r</mi><mi>e</mi><mi>g</mi></mrow></msub></math></span></span><script type="math/tex" id="MathJax-Element-41">L_{reg}</script> all include averaging over whole batch. But it can be skipped now and performed as a last step, when we add these together.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">loss_policy</span> <span class="o">=</span> <span class="o">-</span> <span class="n">logp</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">stop_gradient</span><span class="p">(</span><span class="n">advantage</span><span class="p">)</span>          
</code></pre></div></div>

<p>Now we define <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-42-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-934" style="width: 1.498em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.284em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1001.28em, 2.481em, -999.998em); top: -2.177em; left: 0em;"><span class="mrow" id="MathJax-Span-935"><span class="msubsup" id="MathJax-Span-936"><span style="display: inline-block; position: relative; width: 1.284em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.64em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-937" style="font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.686em;"><span class="mi" id="MathJax-Span-938" style="font-size: 70.7%; font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.13em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.182em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.103em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>L</mi><mi>V</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-42">L_V</script>. Interestingly, the error in this case is the same as the advantage function:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-43-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msup&gt;&lt;munder&gt;&lt;mrow&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;mo&gt;&amp;#x005F;&lt;/mo&gt;&lt;/munder&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-939" style="width: 27.353em; display: inline-block;"><span style="display: inline-block; position: relative; width: 23.378em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.241em, 1023.29em, 2.865em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-940"><span class="mi" id="MathJax-Span-941" style="font-family: MathJax_Math-italic;">e</span><span class="mo" id="MathJax-Span-942" style="font-family: MathJax_Main; padding-left: 0.301em;">=</span><span class="msubsup" id="MathJax-Span-943" style="padding-left: 0.301em;"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-944" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-945" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-946" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="mi" id="MathJax-Span-947" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span class="msubsup" id="MathJax-Span-948"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-949" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-950" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-951" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="msubsup" id="MathJax-Span-952" style="padding-left: 0.216em;"><span style="display: inline-block; position: relative; width: 1.028em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-953" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="mn" id="MathJax-Span-954" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-955"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-956" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-957" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-958" style="font-family: MathJax_Main;">+</span><span class="mo" id="MathJax-Span-959" style="font-family: MathJax_Main;">.</span><span class="mo" id="MathJax-Span-960" style="font-family: MathJax_Main; padding-left: 0.173em;">.</span><span class="mo" id="MathJax-Span-961" style="font-family: MathJax_Main; padding-left: 0.173em;">.</span><span class="mo" id="MathJax-Span-962" style="font-family: MathJax_Main; padding-left: 0.173em;">+</span><span class="msubsup" id="MathJax-Span-963"><span style="display: inline-block; position: relative; width: 2.011em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-964" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="texatom" id="MathJax-Span-965"><span class="mrow" id="MathJax-Span-966"><span class="mi" id="MathJax-Span-967" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span class="mo" id="MathJax-Span-968" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-969" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-970"><span style="display: inline-block; position: relative; width: 1.84em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-971" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="texatom" id="MathJax-Span-972"><span class="mrow" id="MathJax-Span-973"><span class="mi" id="MathJax-Span-974" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span class="mo" id="MathJax-Span-975" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-976" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-977" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="msubsup" id="MathJax-Span-978" style="padding-left: 0.216em;"><span style="display: inline-block; position: relative; width: 1.113em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-979" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="mi" id="MathJax-Span-980" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="munderover" id="MathJax-Span-981"><span style="display: inline-block; position: relative; width: 2.524em; height: 0px;"><span style="position: absolute; clip: rect(3.122em, 1002.44em, 4.404em, -999.998em); top: -4.015em; left: 0.002em;"><span class="mrow" id="MathJax-Span-982"><span class="mi" id="MathJax-Span-983" style="font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-984" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-985"><span style="display: inline-block; position: relative; width: 0.985em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-986" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mi" id="MathJax-Span-987" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-988" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.635em, 1002.52em, 3.934em, -999.998em); top: -3.331em; left: 0em;"><span class="mo" id="MathJax-Span-989" style=""><span style="display: inline-block; position: relative; width: 2.524em; height: 0px;"><span style="position: absolute; font-family: MathJax_Main; top: -4.015em; left: -0.083em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; font-family: MathJax_Main; top: -4.015em; left: 1.84em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 0.387em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 0.857em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 1.37em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-990" style="font-family: MathJax_Main; padding-left: 0.216em;">−</span><span class="mi" id="MathJax-Span-991" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-992" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-993" style="font-family: MathJax_Math-italic;">s</span><span class="mo" id="MathJax-Span-994" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.597em; border-left: 0px solid; width: 0px; height: 1.702em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>e</mi><mo>=</mo><msub><mi>r</mi><mn>0</mn></msub><mo>+</mo><mi>γ</mi><msub><mi>r</mi><mn>1</mn></msub><mo>+</mo><msup><mi>γ</mi><mn>2</mn></msup><msub><mi>r</mi><mn>2</mn></msub><mo>+</mo><mo>.</mo><mo>.</mo><mo>.</mo><mo>+</mo><msup><mi>γ</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msup><msub><mi>r</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>+</mo><msup><mi>γ</mi><mi>n</mi></msup><munder><mrow><mi>V</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><mo>_</mo></munder><mo>−</mo><mi>V</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-43">e = r_0 + \gamma r_1 + \gamma^2 r_2 + ... + \gamma^{n-1} r_{n-1} + \gamma^n \underline{V(s_n)} - V(s)</script>

<p>How could that be? It’s because we made the approximation when computing <em>A(s, a)</em>. We didn’t compute the expectation over all possible chains, but rather used one sample from a run. Note that <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-44-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;munder&gt;&lt;mrow&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;mo&gt;&amp;#x005F;&lt;/mo&gt;&lt;/munder&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-995" style="width: 2.951em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.524em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.284em, 1002.52em, 2.78em, -999.998em); top: -2.177em; left: 0em;"><span class="mrow" id="MathJax-Span-996"><span class="munderover" id="MathJax-Span-997"><span style="display: inline-block; position: relative; width: 2.524em; height: 0px;"><span style="position: absolute; clip: rect(3.122em, 1002.44em, 4.404em, -999.998em); top: -4.015em; left: 0.002em;"><span class="mrow" id="MathJax-Span-998"><span class="mi" id="MathJax-Span-999" style="font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-1000" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-1001"><span style="display: inline-block; position: relative; width: 0.985em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-1002" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mi" id="MathJax-Span-1003" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-1004" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.635em, 1002.52em, 3.934em, -999.998em); top: -3.331em; left: 0em;"><span class="mo" id="MathJax-Span-1005" style=""><span style="display: inline-block; position: relative; width: 2.524em; height: 0px;"><span style="position: absolute; font-family: MathJax_Main; top: -4.015em; left: -0.083em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; font-family: MathJax_Main; top: -4.015em; left: 1.84em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 0.387em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 0.857em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.015em; left: 1.37em;">−<span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.182em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.597em; border-left: 0px solid; width: 0px; height: 1.552em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><munder><mrow><mi>V</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><mo>_</mo></munder></math></span></span><script type="math/tex" id="MathJax-Element-44">\underline{V(s_n)}</script> has to be a constant to avoid gradient leak (we want to optimize <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-45-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-1006" style="width: 2.353em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.011em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1001.92em, 2.652em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-1007"><span class="mi" id="MathJax-Span-1008" style="font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-1009" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-1010" style="font-family: MathJax_Math-italic;">s</span><span class="mo" id="MathJax-Span-1011" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.252em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>V</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-45">V(s)</script>, not <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-46-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-1012" style="width: 2.951em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.524em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1002.44em, 2.652em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-1013"><span class="mi" id="MathJax-Span-1014" style="font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-1015" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-1016"><span style="display: inline-block; position: relative; width: 0.985em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-1017" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mi" id="MathJax-Span-1018" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-1019" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.252em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>V</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mi>n</mi></msub><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-46">V(s_n)</script>. In our implemenation, it is already a constant, because we filled <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-47-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-1020" style="width: 0.9em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.771em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.626em, 1000.77em, 2.481em, -999.998em); top: -2.177em; left: 0em;"><span class="mrow" id="MathJax-Span-1021"><span class="msubsup" id="MathJax-Span-1022"><span style="display: inline-block; position: relative; width: 0.771em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-1023" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mi" id="MathJax-Span-1024" style="font-size: 70.7%; font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.182em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.802em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>r</mi><mi>t</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-47">r_t</script> through a placeholder. <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-48-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-1025" style="width: 1.498em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.284em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1001.28em, 2.481em, -999.998em); top: -2.177em; left: 0em;"><span class="mrow" id="MathJax-Span-1026"><span class="msubsup" id="MathJax-Span-1027"><span style="display: inline-block; position: relative; width: 1.284em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.64em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-1028" style="font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.686em;"><span class="mi" id="MathJax-Span-1029" style="font-size: 70.7%; font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.13em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.182em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.103em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>L</mi><mi>V</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-48">L_V</script> then become:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">loss_value</span>  <span class="o">=</span> <span class="n">C_V</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">advantage</span><span class="p">)</span>                    
</code></pre></div></div>

<p>Finally, we have to define the entropy. The formula for <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-49-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;g&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-1030" style="width: 2.053em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.754em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1001.75em, 2.609em, -999.998em); top: -2.177em; left: 0em;"><span class="mrow" id="MathJax-Span-1031"><span class="msubsup" id="MathJax-Span-1032"><span style="display: inline-block; position: relative; width: 1.754em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.64em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-1033" style="font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.686em;"><span class="texatom" id="MathJax-Span-1034"><span class="mrow" id="MathJax-Span-1035"><span class="mi" id="MathJax-Span-1036" style="font-size: 70.7%; font-family: MathJax_Math-italic;">r</span><span class="mi" id="MathJax-Span-1037" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span class="mi" id="MathJax-Span-1038" style="font-size: 70.7%; font-family: MathJax_Math-italic;">g<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.182em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.398em; border-left: 0px solid; width: 0px; height: 1.252em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>L</mi><mrow class="MJX-TeXAtom-ORD"><mi>r</mi><mi>e</mi><mi>g</mi></mrow></msub></math></span></span><script type="math/tex" id="MathJax-Element-49">L_{reg}</script> is:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-50-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;g&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mfrac&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mfrac&gt;&lt;munderover&gt;&lt;mo&gt;&amp;#x2211;&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/munderover&gt;&lt;mi&gt;H&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;&amp;#x03C0;&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-1039" style="width: 12.267em; display: inline-block;"><span style="display: inline-block; position: relative; width: 10.472em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(0.558em, 1010.39em, 3.592em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-1040"><span class="msubsup" id="MathJax-Span-1041"><span style="display: inline-block; position: relative; width: 1.754em; height: 0px;"><span style="position: absolute; clip: rect(3.207em, 1000.64em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-1042" style="font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.686em;"><span class="texatom" id="MathJax-Span-1043"><span class="mrow" id="MathJax-Span-1044"><span class="mi" id="MathJax-Span-1045" style="font-size: 70.7%; font-family: MathJax_Math-italic;">r</span><span class="mi" id="MathJax-Span-1046" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span class="mi" id="MathJax-Span-1047" style="font-size: 70.7%; font-family: MathJax_Math-italic;">g<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-1048" style="font-family: MathJax_Main; padding-left: 0.301em;">=</span><span class="mo" id="MathJax-Span-1049" style="font-family: MathJax_Main; padding-left: 0.301em;">−</span><span class="mfrac" id="MathJax-Span-1050"><span style="display: inline-block; position: relative; width: 0.729em; height: 0px; margin-right: 0.13em; margin-left: 0.13em;"><span style="position: absolute; clip: rect(3.207em, 1000.43em, 4.147em, -999.998em); top: -4.699em; left: 50%; margin-left: -0.254em;"><span class="mn" id="MathJax-Span-1051" style="font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.464em, 1000.6em, 4.147em, -999.998em); top: -3.331em; left: 50%; margin-left: -0.297em;"><span class="mi" id="MathJax-Span-1052" style="font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(0.9em, 1000.73em, 1.199em, -999.998em); top: -1.28em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.4px solid; width: 0.729em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.071em;"></span></span></span></span><span class="munderover" id="MathJax-Span-1053" style="padding-left: 0.173em;"><span style="display: inline-block; position: relative; width: 1.455em; height: 0px;"><span style="position: absolute; clip: rect(2.951em, 1001.37em, 4.618em, -999.998em); top: -4.015em; left: 0em;"><span class="mo" id="MathJax-Span-1054" style="font-family: MathJax_Size2; vertical-align: 0em;">∑</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.421em, 1001.11em, 4.276em, -999.998em); top: -2.947em; left: 0.13em;"><span class="texatom" id="MathJax-Span-1055"><span class="mrow" id="MathJax-Span-1056"><span class="mi" id="MathJax-Span-1057" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span><span class="mo" id="MathJax-Span-1058" style="font-size: 70.7%; font-family: MathJax_Main;">=</span><span class="mn" id="MathJax-Span-1059" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -5.169em; left: 0.515em;"><span class="texatom" id="MathJax-Span-1060"><span class="mrow" id="MathJax-Span-1061"><span class="mi" id="MathJax-Span-1062" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mi" id="MathJax-Span-1063" style="font-family: MathJax_Math-italic; padding-left: 0.173em;">H<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span class="mo" id="MathJax-Span-1064" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-1065" style="font-family: MathJax_Math-italic;">π<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mo" id="MathJax-Span-1066" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-1067"><span style="display: inline-block; position: relative; width: 0.771em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-1068" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mi" id="MathJax-Span-1069" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-1070" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-1071" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -1.448em; border-left: 0px solid; width: 0px; height: 3.353em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mi>L</mi><mrow class="MJX-TeXAtom-ORD"><mi>r</mi><mi>e</mi><mi>g</mi></mrow></msub><mo>=</mo><mo>−</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow class="MJX-TeXAtom-ORD"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class="MJX-TeXAtom-ORD"><mi>n</mi></mrow></munderover><mi>H</mi><mo stretchy="false">(</mo><mi>π</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-50">L_{reg} = - \frac{1}{n}\sum_{i=1}^{n} H(\pi(s_i))</script>

<p>Again, we need to take care of the possible <code class="language-plaintext highlighter-rouge">NaN</code> error of the <code class="language-plaintext highlighter-rouge">log()</code> function, by adding a small constant.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">entropy</span> <span class="o">=</span> <span class="n">C_E</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keep_dims</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p>Now we add all parts together. In all three formulas above, we skipped the averaging part, but we can compute it now in a single step.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">loss_total</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">loss_policy</span> <span class="o">+</span> <span class="n">loss_value</span> <span class="o">+</span> <span class="n">entropy</span><span class="p">)</span>
</code></pre></div></div>

<p>As a last step, we choose an algorithm that will be used for optimization and define the <em>minimize</em> operation. RMSProp was found to work well and it allows for manual control of learning rate. We have only an approximated gradient in our setting, so we have to proceed in a slow and controlled manner.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">RMSPropOptimizer</span><span class="p">(</span><span class="n">LEARNING_RATE</span><span class="p">,</span> <span class="n">decay</span><span class="o">=</span><span class="mf">.99</span><span class="p">)</span>
        <span class="n">minimize</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">loss_total</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="optimizer">Optimizer</h3>
<p>Last part of the puzzle is <code class="language-plaintext highlighter-rouge">Optimizer</code>. The class itself is very simple, it just a thread that repeatedly calls <code class="language-plaintext highlighter-rouge">brain.optimize()</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_signal</span><span class="p">:</span>
            <span class="n">brain</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
</code></pre></div></div>

<p>So, let’s look at this <code class="language-plaintext highlighter-rouge">brain.optimize()</code> function. It preprocesses data and run the <em>minimize</em> operation we defined earlier. TensorFlow then computes the gradient and changes neural network’s weights.</p>

<p>First, we have to make sure that we have enough samples in the training queue. This is required to get a good quality approximation of the gradient and it also allows for efficient batch computation. If there aren’t enough samples, we simply yield to other threads to do their work.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">MIN_BATCH</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>   <span class="c1"># yield
</span>            <span class="k">return</span>
</code></pre></div></div>

<p>Then we extract all the samples from the queue in a synchronized manner:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_queue</span><span class="p">:</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s_</span><span class="p">,</span> <span class="n">s_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_queue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_queue</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span> <span class="p">]</span>
</code></pre></div></div>

<p>And process them into solid blocks of numpy arrays:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">s_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">s_</span><span class="p">)</span>
        <span class="n">s_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">s_mask</span><span class="p">)</span>
</code></pre></div></div>

<p>The reward received from the training queue is only immediate, excluding the <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-51-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msup&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-1072" style="width: 4.276em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.635em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1003.55em, 2.652em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-1073"><span class="msubsup" id="MathJax-Span-1074"><span style="display: inline-block; position: relative; width: 1.113em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-1075" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.357em; left: 0.6em;"><span class="mi" id="MathJax-Span-1076" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mi" id="MathJax-Span-1077" style="font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-1078" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-1079"><span style="display: inline-block; position: relative; width: 0.985em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-1080" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mi" id="MathJax-Span-1081" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-1082" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.252em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>γ</mi><mi>n</mi></msup><mi>V</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mi>n</mi></msub><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-51">\gamma^n V(s_n)</script> part, so we have to add it.</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-52-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-1083" style="width: 17.908em; display: inline-block;"><span style="display: inline-block; position: relative; width: 15.301em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.241em, 1015.3em, 2.609em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-1084"><span class="mi" id="MathJax-Span-1085" style="font-family: MathJax_Math-italic;">r</span><span class="mo" id="MathJax-Span-1086" style="font-family: MathJax_Main; padding-left: 0.301em;">=</span><span class="msubsup" id="MathJax-Span-1087" style="padding-left: 0.301em;"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-1088" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-1089" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-1090" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="mi" id="MathJax-Span-1091" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span class="msubsup" id="MathJax-Span-1092"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-1093" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-1094" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-1095" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="msubsup" id="MathJax-Span-1096" style="padding-left: 0.216em;"><span style="display: inline-block; position: relative; width: 1.028em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-1097" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="mn" id="MathJax-Span-1098" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-1099"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-1100" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mn" id="MathJax-Span-1101" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-1102" style="font-family: MathJax_Main;">+</span><span class="mo" id="MathJax-Span-1103" style="font-family: MathJax_Main;">.</span><span class="mo" id="MathJax-Span-1104" style="font-family: MathJax_Main; padding-left: 0.173em;">.</span><span class="mo" id="MathJax-Span-1105" style="font-family: MathJax_Main; padding-left: 0.173em;">.</span><span class="mo" id="MathJax-Span-1106" style="font-family: MathJax_Main; padding-left: 0.173em;">+</span><span class="msubsup" id="MathJax-Span-1107"><span style="display: inline-block; position: relative; width: 2.011em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-1108" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.442em; left: 0.6em;"><span class="texatom" id="MathJax-Span-1109"><span class="mrow" id="MathJax-Span-1110"><span class="mi" id="MathJax-Span-1111" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span class="mo" id="MathJax-Span-1112" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-1113" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-1114"><span style="display: inline-block; position: relative; width: 1.84em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-1115" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="texatom" id="MathJax-Span-1116"><span class="mrow" id="MathJax-Span-1117"><span class="mi" id="MathJax-Span-1118" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span class="mo" id="MathJax-Span-1119" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-1120" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.297em; border-left: 0px solid; width: 0px; height: 1.403em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>r</mi><mo>=</mo><msub><mi>r</mi><mn>0</mn></msub><mo>+</mo><mi>γ</mi><msub><mi>r</mi><mn>1</mn></msub><mo>+</mo><msup><mi>γ</mi><mn>2</mn></msup><msub><mi>r</mi><mn>2</mn></msub><mo>+</mo><mo>.</mo><mo>.</mo><mo>.</mo><mo>+</mo><msup><mi>γ</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msup><msub><mi>r</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-52">r = r_0 + \gamma r_1 + \gamma^2 r_2 + ... + \gamma^{n-1} r_{n-1}</script>

<p>Fortunately, this can be efficiently done on GPU for all states in a batch in parallel.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_v</span><span class="p">(</span><span class="n">s_</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="n">GAMMA_N</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">s_mask</span>
</code></pre></div></div>

<p>First we compute the <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-53-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-1121" style="width: 2.951em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.524em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1002.44em, 2.652em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-1122"><span class="mi" id="MathJax-Span-1123" style="font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-1124" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-1125"><span style="display: inline-block; position: relative; width: 0.985em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-1126" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mi" id="MathJax-Span-1127" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-1128" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.252em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>V</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mi>n</mi></msub><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-53">V(s_n)</script> for all landing states. Then we add it to the <code class="language-plaintext highlighter-rouge">r</code> matrix, again by using vectorized operation.</p>

<p>But, if the landing state is terminal, we shouldn’t add the <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-54-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msup&gt;&lt;mi&gt;V&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-1129" style="width: 4.276em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.635em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.37em, 1003.55em, 2.652em, -999.998em); top: -2.263em; left: 0em;"><span class="mrow" id="MathJax-Span-1130"><span class="msubsup" id="MathJax-Span-1131"><span style="display: inline-block; position: relative; width: 1.113em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.56em, 4.361em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-1132" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -4.357em; left: 0.6em;"><span class="mi" id="MathJax-Span-1133" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mi" id="MathJax-Span-1134" style="font-family: MathJax_Math-italic;">V<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.173em;"></span></span><span class="mo" id="MathJax-Span-1135" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-1136"><span style="display: inline-block; position: relative; width: 0.985em; height: 0px;"><span style="position: absolute; clip: rect(3.464em, 1000.43em, 4.147em, -999.998em); top: -4.015em; left: 0em;"><span class="mi" id="MathJax-Span-1137" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span><span style="position: absolute; top: -3.844em; left: 0.472em;"><span class="mi" id="MathJax-Span-1138" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 4.019em;"></span></span></span></span><span class="mo" id="MathJax-Span-1139" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.267em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.252em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>γ</mi><mi>n</mi></msup><mi>V</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mi>n</mi></msub><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-54">\gamma^n V(s_n)</script> term. However, we cleverly prepared the <code class="language-plaintext highlighter-rouge">s_mask</code> array that is <code class="language-plaintext highlighter-rouge">0</code> in case of terminal state and <code class="language-plaintext highlighter-rouge">1</code> otherwise. This simple trick allows us to still use vectorized operation. Although run on CPU, modern instructions allow for matrix multiplication that is much quicker than a loop implementation. There is only a small overhead by computing the values for <code class="language-plaintext highlighter-rouge">NONE_STATE</code>. However, these states are sparse and the cost is small compared to selective computation.</p>

<p>Finally, we extract the placeholders, run the <em>minimize</em> operation and TensorFlow will do the rest.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">s_t</span><span class="p">,</span> <span class="n">a_t</span><span class="p">,</span> <span class="n">r_t</span><span class="p">,</span> <span class="n">minimize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">minimize</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="n">s_t</span><span class="p">:</span> <span class="n">s</span><span class="p">,</span> <span class="n">a_t</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="n">r_t</span><span class="p">:</span> <span class="n">r_</span><span class="p">})</span>
</code></pre></div></div>

<p>So, the optimizer runs the <em>minimize</em> operation tirelessly in a loop. However, one optimizer is often not enough. But nothing stops us from running multiple optimizers at the same time. And indeed, in practice two optimizers are much more efficient than one. While one is occupied by running a GPU operation, the other can preprocess the data. One optimizer often struggles to keep pace with incoming data. If it can’t consume incoming samples quickly, the queue keeps growing and it leads to problems.</p>

<h3 id="main">Main</h3>
<p>The main program starts with determining the shape of states and actions in a given environment. This allows for fast switching of environments simply by changing a single constant (at least for simple environments).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">env_test</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="n">render</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">eps_start</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">eps_end</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
    <span class="n">NUM_STATE</span> <span class="o">=</span> <span class="n">env_test</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">observation_space</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">NUM_ACTIONS</span> <span class="o">=</span> <span class="n">env_test</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">n</span>
</code></pre></div></div>

<p>Then it creates instances of <code class="language-plaintext highlighter-rouge">Brain</code>, <code class="language-plaintext highlighter-rouge">Environment</code> and <code class="language-plaintext highlighter-rouge">Optimizer</code>.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">brain</span> <span class="o">=</span> <span class="n">Brain</span><span class="p">()</span>
    <span class="n">envs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Environment</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">THREADS</span><span class="p">)]</span>
    <span class="n">opts</span> <span class="o">=</span> <span class="p">[</span><span class="n">Optimizer</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">OPTIMIZERS</span><span class="p">)]</span>
</code></pre></div></div>

<p>Finally, it just starts the threads, wait given number of seconds, stops them and displays a trained agent to the user.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
        <span class="n">o</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">envs</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">RUN_TIME</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">envs</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">envs</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
        <span class="n">o</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
        <span class="n">o</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="n">env_test</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="remarks">Remarks</h2>
<p>Positive results were experienced when using different exploration constants for different agents<sup id="fnref:1:1"><a href="https://jaromiru.com/2017/03/26/lets-make-an-a3c-implementation/#fn:1" class="footnote">2</a></sup>. In this implementation, however, a single value for all agents is used for simplicity.</p>

<p>The results are highly variable. In case of <em>CartPole</em> environment, almost all runs result in a capable agent. However, in general the algorithm is very sensitive to starting conditions and in more complex environments it might result in very variable performance. You should average several runs if you want to measure progress.</p>

<p>This is a table of all constants used in the algorithm:</p>

<table>
  <thead>
    <tr>
      <th>Parameter</th>
      <th>Value</th>
      <th>Explanation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>agent threads</td>
      <td>8</td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td>optimizer threads</td>
      <td>2</td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td>thread delay</td>
      <td>0.001 s</td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td>γ</td>
      <td>0.99</td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td>ε<sub>start</sub></td>
      <td>0.40</td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td>ε<sub>stop</sub></td>
      <td>0.15</td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td>ε<sub>steps</sub></td>
      <td>75 000</td>
      <td>ε will come down to ε<sub>stop</sub> after ε<sub>steps</sub></td>
    </tr>
    <tr>
      <td>n-step</td>
      <td>8</td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td>minimal batch size</td>
      <td>32</td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td>RMSprop learning rate</td>
      <td>0.005</td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td>c<sub>v</sub></td>
      <td>0.5</td>
      <td>L<sub>V</sub> constant</td>
    </tr>
    <tr>
      <td>c<sub>reg</sub></td>
      <td>0.01</td>
      <td>L<sub>reg</sub> constant</td>
    </tr>
    <tr>
      <td>training time</td>
      <td>30s</td>
      <td>&nbsp;</td>
    </tr>
  </tbody>
</table>

<h2 id="results">Results</h2>
<p>I trained the agent on my MacBook with integrated NVIDIA GeForce GT 750M 2048MB GPU. The CPU has four physical cores, but I used 8 agents. The number of agents directly affects the performance, because it influences the quality of the gradient. You should tweak the hyperparameters to work best on your setup.</p>

<p>Training takes 30 seconds during which the algorithm goes through roughly 1000 episodes and 65 000 steps, that corresponds to about 2 200 steps per second. Results averaged over 10 runs are shown below:</p>

<p><img src="./A3C_ Implementation_files/graph.png" alt="Average achieved score"></p>

<p>You can see a demonstration how a trained agent behaves below:</p>

<p><img class="w70" src="./A3C_ Implementation_files/policy_animation.gif" alt="Agent animation"></p>

<p>You can download the code from <a href="https://github.com/jaromiru/AI-blog/blob/master/CartPole-A3C.py">GitHub</a>. Feel free to use it as a base for your experiments or developing more capable agents. If you have any other questions, do not hesitate to ask me in comments.</p>

<h2 id="references">References</h2>
<div class="footnotes">
  <ol>
    <li id="fn:2">
      <p>Babaeizadeh, M., <em>Reinforcement Learning through Asynchronous Advantage Actor-Critic on a GPU</em>, 2016, <a href="https://arxiv.org/abs/1611.06256">arxiv</a>, <a href="https://github.com/NVlabs/GA3C">code</a>&nbsp;<a href="https://jaromiru.com/2017/03/26/lets-make-an-a3c-implementation/#fnref:2" class="reversefootnote">↩</a></p>
    </li>
    <li id="fn:1">
      <p>Mnih, V. et al., <em>Asynchronous methods for deep reinforcement learning</em>, 2016, <a href="https://arxiv.org/abs/1602.01783">arxiv</a>&nbsp;<a href="https://jaromiru.com/2017/03/26/lets-make-an-a3c-implementation/#fnref:1" class="reversefootnote">↩</a>&nbsp;<a href="https://jaromiru.com/2017/03/26/lets-make-an-a3c-implementation/#fnref:1:1" class="reversefootnote">↩<sup>2</sup></a></p>
    </li>
  </ol>
</div>

</article>






  <div id="disqus_thread"><iframe id="dsq-app9137" name="dsq-app9137" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="./A3C_ Implementation_files/saved_resource.html" horizontalscrolling="no" verticalscrolling="no" style="height: 8678px !important;"></iframe></div>
  <script type="text/javascript">
    var disqus_shortname  = 'jaromiru-com';
    var disqus_identifier = '/2017/03/26/lets-make-an-a3c-implementation';
    var disqus_title      = "Let’s make an A3C: Implementation";

    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>






      </div>
    </div>
  </div>

  <footer class="center">
  <div class="measure">
    <small><a href="https://jaromiru.com/2017/03/26/lets-make-an-a3c-implementation/#">back to top</a> | based on <a href="https://github.com/johnotander/pixyll">Pixyll</a> theme</small>
  </div>
</footer>




<iframe style="display: none;" src="./A3C_ Implementation_files/saved_resource(1).html"></iframe><div style="position: absolute; width: 0px; height: 0px; overflow: hidden; padding: 0px; border: 0px; margin: 0px;"><div id="MathJax_Font_Test" style="position: absolute; visibility: hidden; top: 0px; left: 0px; width: auto; padding: 0px; border: 0px; margin: 0px; white-space: nowrap; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; font-size: 40px; font-weight: normal; font-style: normal; font-family: MathJax_Size2, sans-serif;"></div></div></body></html>